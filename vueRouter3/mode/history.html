<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>History模式 | 前端源码解读</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="前端源码解读文档;使用过程中如碰到问题，请到Github进行提问。 https://github.com/CrayonPig/originCodeCommit">
    
    <link rel="preload" href="/assets/css/0.styles.96eb8417.css" as="style"><link rel="preload" href="/assets/js/app.ad3c3e04.js" as="script"><link rel="preload" href="/assets/js/2.88c18509.js" as="script"><link rel="preload" href="/assets/js/1.d4c099ff.js" as="script"><link rel="preload" href="/assets/js/94.ffcef793.js" as="script"><link rel="prefetch" href="/assets/js/10.b14aa6d6.js"><link rel="prefetch" href="/assets/js/100.614ddf91.js"><link rel="prefetch" href="/assets/js/101.4c65b4d0.js"><link rel="prefetch" href="/assets/js/102.376b4812.js"><link rel="prefetch" href="/assets/js/103.84d389c8.js"><link rel="prefetch" href="/assets/js/104.d191548f.js"><link rel="prefetch" href="/assets/js/105.f51cd683.js"><link rel="prefetch" href="/assets/js/106.950a82b6.js"><link rel="prefetch" href="/assets/js/107.528e252d.js"><link rel="prefetch" href="/assets/js/108.afe9f7c8.js"><link rel="prefetch" href="/assets/js/109.e39fdc66.js"><link rel="prefetch" href="/assets/js/11.9fe1d85e.js"><link rel="prefetch" href="/assets/js/110.8829b75c.js"><link rel="prefetch" href="/assets/js/111.434e2a74.js"><link rel="prefetch" href="/assets/js/112.64afad29.js"><link rel="prefetch" href="/assets/js/113.5859888c.js"><link rel="prefetch" href="/assets/js/12.86508e15.js"><link rel="prefetch" href="/assets/js/13.f076dea0.js"><link rel="prefetch" href="/assets/js/14.4a65991d.js"><link rel="prefetch" href="/assets/js/15.42e542bb.js"><link rel="prefetch" href="/assets/js/16.42d8df26.js"><link rel="prefetch" href="/assets/js/17.11d996a2.js"><link rel="prefetch" href="/assets/js/18.6f8f0eec.js"><link rel="prefetch" href="/assets/js/19.67e71589.js"><link rel="prefetch" href="/assets/js/20.9f10fe7c.js"><link rel="prefetch" href="/assets/js/21.33279d3b.js"><link rel="prefetch" href="/assets/js/22.ba4edf56.js"><link rel="prefetch" href="/assets/js/23.f26baabe.js"><link rel="prefetch" href="/assets/js/24.3a26f8a0.js"><link rel="prefetch" href="/assets/js/25.05439b46.js"><link rel="prefetch" href="/assets/js/26.53596522.js"><link rel="prefetch" href="/assets/js/27.ce419d8c.js"><link rel="prefetch" href="/assets/js/28.7cb9e5eb.js"><link rel="prefetch" href="/assets/js/29.46e8d12b.js"><link rel="prefetch" href="/assets/js/3.47d5fbb2.js"><link rel="prefetch" href="/assets/js/30.edf0a1ec.js"><link rel="prefetch" href="/assets/js/31.1d374c07.js"><link rel="prefetch" href="/assets/js/32.366b2cf4.js"><link rel="prefetch" href="/assets/js/33.68c83345.js"><link rel="prefetch" href="/assets/js/34.b965ddb1.js"><link rel="prefetch" href="/assets/js/35.a1c6adf9.js"><link rel="prefetch" href="/assets/js/36.63c8dfd6.js"><link rel="prefetch" href="/assets/js/37.521f7845.js"><link rel="prefetch" href="/assets/js/38.d856947f.js"><link rel="prefetch" href="/assets/js/39.c5251a61.js"><link rel="prefetch" href="/assets/js/4.37747ac1.js"><link rel="prefetch" href="/assets/js/40.5a8b85f9.js"><link rel="prefetch" href="/assets/js/41.f9bafedc.js"><link rel="prefetch" href="/assets/js/42.9ad271c2.js"><link rel="prefetch" href="/assets/js/43.f5a3f58d.js"><link rel="prefetch" href="/assets/js/44.14a61094.js"><link rel="prefetch" href="/assets/js/45.6b284ba9.js"><link rel="prefetch" href="/assets/js/46.30f8291b.js"><link rel="prefetch" href="/assets/js/47.187fcc55.js"><link rel="prefetch" href="/assets/js/48.3e8db2ba.js"><link rel="prefetch" href="/assets/js/49.6884e960.js"><link rel="prefetch" href="/assets/js/5.094ae013.js"><link rel="prefetch" href="/assets/js/50.04fe3b2f.js"><link rel="prefetch" href="/assets/js/51.383554b2.js"><link rel="prefetch" href="/assets/js/52.c1bd565b.js"><link rel="prefetch" href="/assets/js/53.8cf60731.js"><link rel="prefetch" href="/assets/js/54.4b0f4208.js"><link rel="prefetch" href="/assets/js/55.b1b4491a.js"><link rel="prefetch" href="/assets/js/56.375f57cf.js"><link rel="prefetch" href="/assets/js/57.28565941.js"><link rel="prefetch" href="/assets/js/58.881be944.js"><link rel="prefetch" href="/assets/js/59.c2e14c93.js"><link rel="prefetch" href="/assets/js/6.77b934eb.js"><link rel="prefetch" href="/assets/js/60.71e19ab9.js"><link rel="prefetch" href="/assets/js/61.5040948e.js"><link rel="prefetch" href="/assets/js/62.68da2576.js"><link rel="prefetch" href="/assets/js/63.ba696df8.js"><link rel="prefetch" href="/assets/js/64.e0cc234a.js"><link rel="prefetch" href="/assets/js/65.3f0fb824.js"><link rel="prefetch" href="/assets/js/66.ed0ed3d5.js"><link rel="prefetch" href="/assets/js/67.6ed392a4.js"><link rel="prefetch" href="/assets/js/68.2f7ab3b3.js"><link rel="prefetch" href="/assets/js/69.f8842641.js"><link rel="prefetch" href="/assets/js/7.b4d7955c.js"><link rel="prefetch" href="/assets/js/70.9ce01281.js"><link rel="prefetch" href="/assets/js/71.ef72f0c7.js"><link rel="prefetch" href="/assets/js/72.56e8c587.js"><link rel="prefetch" href="/assets/js/73.f3d06aee.js"><link rel="prefetch" href="/assets/js/74.7f44f797.js"><link rel="prefetch" href="/assets/js/75.d00103c4.js"><link rel="prefetch" href="/assets/js/76.2fbbd523.js"><link rel="prefetch" href="/assets/js/77.a0ebb584.js"><link rel="prefetch" href="/assets/js/78.f8372a44.js"><link rel="prefetch" href="/assets/js/79.44a8baa0.js"><link rel="prefetch" href="/assets/js/80.89d4968b.js"><link rel="prefetch" href="/assets/js/81.4b597cff.js"><link rel="prefetch" href="/assets/js/82.59501886.js"><link rel="prefetch" href="/assets/js/83.719b4688.js"><link rel="prefetch" href="/assets/js/84.c212d6db.js"><link rel="prefetch" href="/assets/js/85.e8667809.js"><link rel="prefetch" href="/assets/js/86.2b8502c5.js"><link rel="prefetch" href="/assets/js/87.bc499af2.js"><link rel="prefetch" href="/assets/js/88.9dfb8b4b.js"><link rel="prefetch" href="/assets/js/89.10e4e85d.js"><link rel="prefetch" href="/assets/js/90.31bd9ad6.js"><link rel="prefetch" href="/assets/js/91.b89991ae.js"><link rel="prefetch" href="/assets/js/92.7629a821.js"><link rel="prefetch" href="/assets/js/93.033ea1f5.js"><link rel="prefetch" href="/assets/js/95.dddcd8b1.js"><link rel="prefetch" href="/assets/js/96.0e82532d.js"><link rel="prefetch" href="/assets/js/97.2787fd58.js"><link rel="prefetch" href="/assets/js/98.fd11b897.js"><link rel="prefetch" href="/assets/js/99.1a7b0042.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.68b347c4.js">
    <link rel="stylesheet" href="/assets/css/0.styles.96eb8417.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">前端源码解读</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Vue2相关" class="dropdown-title"><span class="title">Vue2相关</span> <span class="arrow down"></span></button> <button type="button" aria-label="Vue2相关" class="mobile-dropdown-title"><span class="title">Vue2相关</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vue2/" class="nav-link">
  Vue2
</a></li><li class="dropdown-item"><!----> <a href="/vueRouter3/" class="nav-link router-link-active">
  Vue Route V3
</a></li><li class="dropdown-item"><!----> <a href="/vuex3/" class="nav-link">
  VueX V3
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/CrayonPig/originCodeCommit" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Vue2相关" class="dropdown-title"><span class="title">Vue2相关</span> <span class="arrow down"></span></button> <button type="button" aria-label="Vue2相关" class="mobile-dropdown-title"><span class="title">Vue2相关</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vue2/" class="nav-link">
  Vue2
</a></li><li class="dropdown-item"><!----> <a href="/vueRouter3/" class="nav-link router-link-active">
  Vue Route V3
</a></li><li class="dropdown-item"><!----> <a href="/vuex3/" class="nav-link">
  VueX V3
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/CrayonPig/originCodeCommit" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/vueRouter3/" aria-current="page" class="sidebar-link">Vue Router V3 源码解析</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>准备工作</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vueRouter3/prepare/directory.html" class="sidebar-link">目录结构</a></li><li><a href="/vueRouter3/prepare/build.html" class="sidebar-link">源码构建</a></li><li><a href="/vueRouter3/prepare/entry.html" class="sidebar-link">源码入口</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>初始化</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vueRouter3/init/" class="sidebar-link">前言</a></li><li><a href="/vueRouter3/init/install.html" class="sidebar-link">注册插件</a></li><li><a href="/vueRouter3/init/instantiate.html" class="sidebar-link">实例化</a></li><li><a href="/vueRouter3/init/mount.html" class="sidebar-link">挂载</a></li><li><a href="/vueRouter3/init/addComponent.html" class="sidebar-link">使用组件</a></li><li><a href="/vueRouter3/init/summary.html" class="sidebar-link">总结</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>路由匹配</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vueRouter3/matcher/" class="sidebar-link">路由介绍</a></li><li><a href="/vueRouter3/matcher/matcher.html" class="sidebar-link">匹配器</a></li><li><a href="/vueRouter3/matcher/summary.html" class="sidebar-link">总结</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>路由模式</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vueRouter3/mode/" aria-current="page" class="sidebar-link">简介</a></li><li><a href="/vueRouter3/mode/history.html" aria-current="page" class="active sidebar-link">History模式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vueRouter3/mode/history.html#实例化" class="sidebar-link">实例化</a></li><li class="sidebar-sub-header"><a href="/vueRouter3/mode/history.html#初始化" class="sidebar-link">初始化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vueRouter3/mode/history.html#transitionto" class="sidebar-link">transitionTo</a></li><li class="sidebar-sub-header"><a href="/vueRouter3/mode/history.html#confirmtransition" class="sidebar-link">confirmTransition</a></li><li class="sidebar-sub-header"><a href="/vueRouter3/mode/history.html#listen" class="sidebar-link">listen</a></li><li class="sidebar-sub-header"><a href="/vueRouter3/mode/history.html#setuplisteners" class="sidebar-link">setupListeners</a></li></ul></li><li class="sidebar-sub-header"><a href="/vueRouter3/mode/history.html#常见方法" class="sidebar-link">常见方法</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vueRouter3/mode/history.html#push" class="sidebar-link">push</a></li><li class="sidebar-sub-header"><a href="/vueRouter3/mode/history.html#replace" class="sidebar-link">replace</a></li><li class="sidebar-sub-header"><a href="/vueRouter3/mode/history.html#go" class="sidebar-link">go</a></li><li class="sidebar-sub-header"><a href="/vueRouter3/mode/history.html#back" class="sidebar-link">back</a></li></ul></li><li class="sidebar-sub-header"><a href="/vueRouter3/mode/history.html#总结" class="sidebar-link">总结</a></li></ul></li><li><a href="/vueRouter3/mode/hash.html" class="sidebar-link">Hash模式</a></li><li><a href="/vueRouter3/mode/abstract.html" class="sidebar-link">Abstract模式</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>进阶</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vueRouter3/advanced/navigation-guards.html" class="sidebar-link">导航守卫</a></li><li><a href="/vueRouter3/advanced/route-view.html" class="sidebar-link">&lt;router-view&gt;</a></li><li><a href="/vueRouter3/advanced/route-link.html" class="sidebar-link">&lt;router-link&gt;</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="history模式"><a href="#history模式" class="header-anchor">#</a> History模式</h1> <h2 id="实例化"><a href="#实例化" class="header-anchor">#</a> 实例化</h2> <p>我们之前分析过，在<code>new VueRouter</code>的时候，通过判断传入的<code>mode</code>来判断最后初始化路由模式</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">this</span><span class="token punctuation">.</span>history <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HTML5History</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>base<span class="token punctuation">)</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1701340876225-27079">成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="this.history = new HTML5History(this, options.base)
" data-mdic-attach-content="" data-mdic-notify-id="j-notify-1701340876225-27079" data-mdic-notify-delay="2000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t='',e='')=&gt;new Promise((c,o)=&gt;{const n=document.createElement('textarea'),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display='block',setTimeout(()=&gt;{n.style.display='none'},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制代码</button></div></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>上述代码可以看出，初始化的时候，会创建一个<code>HTML5History</code>实例，将<code>this</code>和设定的基准路径<code>base</code>传入，我们找到<code>HTML5History</code>的定义</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// src/history/html5.js</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">HTML5History</span> <span class="token keyword">extends</span> <span class="token class-name">History</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">_startLocation</span><span class="token operator">:</span> string
  <span class="token comment">// base 为基准地址</span>
  <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">router</span><span class="token operator">:</span> Router<span class="token punctuation">,</span> <span class="token literal-property property">base</span><span class="token operator">:</span> <span class="token operator">?</span>string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>router<span class="token punctuation">,</span> base<span class="token punctuation">)</span>
    <span class="token comment">// 拼接完整的初始地址</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_startLocation <span class="token operator">=</span> <span class="token function">getLocation</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>base<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1701340876225-3614">成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="// src/history/html5.js
export class HTML5History extends History {
  _startLocation: string
  // base 为基准地址
  constructor (router: Router, base: ?string) {
    super(router, base)
    // 拼接完整的初始地址
    this._startLocation = getLocation(this.base)
  }
}
" data-mdic-attach-content="" data-mdic-notify-id="j-notify-1701340876225-3614" data-mdic-notify-delay="2000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t='',e='')=&gt;new Promise((c,o)=&gt;{const n=document.createElement('textarea'),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display='block',setTimeout(()=&gt;{n.style.display='none'},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制代码</button></div></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>可以看到，<code>HTML5History</code>继承自<code>History</code>，并且初始化的时候，先调用了<code>super</code>，传入了<code>router</code>和<code>base</code>，我们找到<code>History</code>的定义</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// src/history/base.js</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">History</span> <span class="token punctuation">{</span>
  <span class="token comment">// base 为基准地址</span>
  <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">router</span><span class="token operator">:</span> Router<span class="token punctuation">,</span> <span class="token literal-property property">base</span><span class="token operator">:</span> <span class="token operator">?</span>string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>router <span class="token operator">=</span> router
    <span class="token comment">// 格式化base</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>base <span class="token operator">=</span> <span class="token function">normalizeBase</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span>
    <span class="token comment">// start with a route object that stands for &quot;nowhere&quot;</span>
    <span class="token comment">// 创建当前路由为初始路由</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token constant">START</span>
    <span class="token comment">// 即将导航到的目标路由信息</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>pending <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token comment">// 是否已经准备就绪</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ready <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token comment">// 准备就绪的回调函数</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>readyCbs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token comment">// 准备失败时的回调函数</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>readyErrorCbs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token comment">// 出错时的回调函数</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>errorCbs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token comment">// 监听路由变化的回调函数</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>listeners <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1701340876225-29859">成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="// src/history/base.js
export class History {
  // base 为基准地址
  constructor (router: Router, base: ?string) {
    this.router = router
    // 格式化base
    this.base = normalizeBase(base)
    // start with a route object that stands for &quot;nowhere&quot;
    // 创建当前路由为初始路由
    this.current = START
    // 即将导航到的目标路由信息
    this.pending = null
    // 是否已经准备就绪
    this.ready = false
    // 准备就绪的回调函数
    this.readyCbs = []
    // 准备失败时的回调函数
    this.readyErrorCbs = []
    // 出错时的回调函数
    this.errorCbs = []
    // 监听路由变化的回调函数
    this.listeners = []
  }
}
" data-mdic-attach-content="" data-mdic-notify-id="j-notify-1701340876225-29859" data-mdic-notify-delay="2000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t='',e='')=&gt;new Promise((c,o)=&gt;{const n=document.createElement('textarea'),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display='block',setTimeout(()=&gt;{n.style.display='none'},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制代码</button></div></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p><code>History</code>中，先调用<code>normalizeBase</code>格式化了<code>base</code>，然后创建当前路由为初始路由<code>START</code>，并且定义了一些变量。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 格式化base</span>
<span class="token keyword">function</span> <span class="token function">normalizeBase</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">base</span><span class="token operator">:</span> <span class="token operator">?</span>string</span><span class="token punctuation">)</span><span class="token operator">:</span> string <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>base<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>inBrowser<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//  &lt;base&gt; 规定页面上所有链接的默认 URL 和默认目标</span>
      <span class="token keyword">const</span> baseEl <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'base'</span><span class="token punctuation">)</span>
      base <span class="token operator">=</span> <span class="token punctuation">(</span>baseEl <span class="token operator">&amp;&amp;</span> baseEl<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">'href'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">'/'</span>
      <span class="token comment">// strip full URL origin</span>
      <span class="token comment">// 去除URL origin</span>
      base <span class="token operator">=</span> base<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^https?:\/\/[^\/]+</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      base <span class="token operator">=</span> <span class="token string">'/'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 确保base 开头是/</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>base<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    base <span class="token operator">=</span> <span class="token string">'/'</span> <span class="token operator">+</span> base
  <span class="token punctuation">}</span>
  <span class="token comment">// 删除尾部/</span>
  <span class="token keyword">return</span> base<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\/$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1701340876225-6708">成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="// 格式化base
function normalizeBase (base: ?string): string {
  if (!base) {
    if (inBrowser) {
      //  &lt;base&gt; 规定页面上所有链接的默认 URL 和默认目标
      const baseEl = document.querySelector('base')
      base = (baseEl &amp;&amp; baseEl.getAttribute('href')) || '/'
      // strip full URL origin
      // 去除URL origin
      base = base.replace(/^https?:\/\/[^\/]+/, '')
    } else {
      base = '/'
    }
  }
  // 确保base 开头是/
  if (base.charAt(0) !== '/') {
    base = '/' + base
  }
  // 删除尾部/
  return base.replace(/\/$/, '')
}
" data-mdic-attach-content="" data-mdic-notify-id="j-notify-1701340876225-6708" data-mdic-notify-delay="2000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t='',e='')=&gt;new Promise((c,o)=&gt;{const n=document.createElement('textarea'),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display='block',setTimeout(()=&gt;{n.style.display='none'},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制代码</button></div></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p><code>normalizeBase</code>首先会判断<code>base</code>是否为空，如果为空，则根据浏览器环境来获取<code>base</code>，然后去除<code>base</code>的<code>origin</code>，只保留路径，最后将<code>base</code>开头加上<code>/</code>，删除尾部的<code>/</code>。</p> <p>也就是说，当我传入的<code>base</code>是<code>/login/</code>时，最后处理完毕是<code>/login</code>。如果没传入，浏览器标签<code>&lt;base&gt;</code>有设置的情况下取后缀路径，否则就是默认<code>/</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">this</span><span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token constant">START</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">START</span> <span class="token operator">=</span> <span class="token function">createRoute</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token string">'/'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1701340876225-18757">成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="this.current = START

export const START = createRoute(null, {
  path: '/'
})
" data-mdic-attach-content="" data-mdic-notify-id="j-notify-1701340876225-18757" data-mdic-notify-delay="2000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t='',e='')=&gt;new Promise((c,o)=&gt;{const n=document.createElement('textarea'),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display='block',setTimeout(()=&gt;{n.style.display='none'},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制代码</button></div></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>创建当前路由为初始路由<code>START</code>，实际上是调用<code>createRoute</code>方法，创建了一个<code>path</code>为<code>/</code>空的路由对象</p> <p><code>History</code>初始化完毕后，我们再回到<code>HTML5History</code>的定义，接下来，调用了<code>getLocation</code>方法，将<code>this.base</code>传入，注意，此时的<code>this.base</code>是已经被格式化后的基准路径</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 拼接完整的初始地址</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>_startLocation <span class="token operator">=</span> <span class="token function">getLocation</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>base<span class="token punctuation">)</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1701340876225-1075">成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="// 拼接完整的初始地址
this._startLocation = getLocation(this.base)
" data-mdic-attach-content="" data-mdic-notify-id="j-notify-1701340876225-1075" data-mdic-notify-delay="2000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t='',e='')=&gt;new Promise((c,o)=&gt;{const n=document.createElement('textarea'),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display='block',setTimeout(()=&gt;{n.style.display='none'},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制代码</button></div></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>到现在为止，<code>HTML5History</code>的实例化已经完毕，接下来我们看<code>Vue Router</code>执行<code>init</code>初始化的时候，<code>history</code>做了什么操作</p> <h2 id="初始化"><a href="#初始化" class="header-anchor">#</a> 初始化</h2> <p>这里的初始化，不是指<code>Vue Router</code>的初始化，而是之前我们分析的 <code>VueRouter</code> 中混入的 <code>beforeCreate</code>当中调用的<code>init</code>方法</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// src/router.js</span>
<span class="token function">init</span> <span class="token punctuation">(</span>app<span class="token operator">:</span> any <span class="token comment">/* Vue component instance */</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// .......</span>
  <span class="token comment">// 获取 this.$router mode 对应的 history 对象</span>
  <span class="token keyword">const</span> history <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>history
  <span class="token comment">// 如果是浏览器的 history 或 hash 模式</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>history <span class="token keyword">instanceof</span> <span class="token class-name">HTML5History</span> <span class="token operator">||</span> history <span class="token keyword">instanceof</span> <span class="token class-name">HashHistory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 操作初始化滚动 </span>
    <span class="token comment">// routeOrError 表示要跳转的 route</span>
    <span class="token keyword">const</span> <span class="token function-variable function">handleInitialScroll</span> <span class="token operator">=</span> <span class="token parameter">routeOrError</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 表示即将要跳出的 route</span>
      <span class="token keyword">const</span> from <span class="token operator">=</span> history<span class="token punctuation">.</span>current
      <span class="token comment">// 期望滚动的函数</span>
      <span class="token keyword">const</span> expectScroll <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>scrollBehavior
      <span class="token comment">// 如果mode=history，且当前浏览器支持 h5 history， 则表示支持期望滚动函数</span>
      <span class="token keyword">const</span> supportsScroll <span class="token operator">=</span> supportsPushState <span class="token operator">&amp;&amp;</span> expectScroll
      <span class="token comment">// routeOrError 存在 fullPath 属性， 且 supportsScroll 函数存在</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>supportsScroll <span class="token operator">&amp;&amp;</span> <span class="token string">'fullPath'</span> <span class="token keyword">in</span> routeOrError<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">handleScroll</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> routeOrError<span class="token punctuation">,</span> from<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 如果跳转成功，则传递的参数为 route</span>
    <span class="token comment">// 如果跳转失败，则传递的参数为 error</span>
    <span class="token keyword">const</span> <span class="token function-variable function">setupListeners</span> <span class="token operator">=</span> <span class="token parameter">routeOrError</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      history<span class="token punctuation">.</span><span class="token function">setupListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token function">handleInitialScroll</span><span class="token punctuation">(</span>routeOrError<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * 此次的跳转是针对浏览器地址栏上的 url 进行跳转。
     * 地址栏可能是根路径: http://localhost:8080/；也可能是某个网页的路径 http://localhost:8080/user/info;
     */</span>
    history<span class="token punctuation">.</span><span class="token function">transitionTo</span><span class="token punctuation">(</span>
      <span class="token comment">// 获取浏览器地址栏上的 url。</span>
      <span class="token comment">// history.getCurrentLocation()： 返回的是访问地址字符串</span>
      history<span class="token punctuation">.</span><span class="token function">getCurrentLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token comment">// 路径跳转成功的回调</span>
      setupListeners<span class="token punctuation">,</span>
      <span class="token comment">// 路径跳转失败的回调</span>
      setupListeners
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 在路由变化时，将新的路由对象同步到所有 Vue 实例中，从而触发 Vue 的重新渲染，展示新的页面内容</span>
  history<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token parameter">route</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>apps<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      app<span class="token punctuation">.</span>_route <span class="token operator">=</span> route
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1701340876225-67533">成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="// src/router.js
init (app: any /* Vue component instance */) {
  // .......
  // 获取 this.$router mode 对应的 history 对象
  const history = this.history
  // 如果是浏览器的 history 或 hash 模式
  if (history instanceof HTML5History || history instanceof HashHistory) {
    // 操作初始化滚动 
    // routeOrError 表示要跳转的 route
    const handleInitialScroll = routeOrError =&gt; {
      // 表示即将要跳出的 route
      const from = history.current
      // 期望滚动的函数
      const expectScroll = this.options.scrollBehavior
      // 如果mode=history，且当前浏览器支持 h5 history， 则表示支持期望滚动函数
      const supportsScroll = supportsPushState &amp;&amp; expectScroll
      // routeOrError 存在 fullPath 属性， 且 supportsScroll 函数存在
      if (supportsScroll &amp;&amp; 'fullPath' in routeOrError) {
        handleScroll(this, routeOrError, from, false)
      }
    }
    // 如果跳转成功，则传递的参数为 route
    // 如果跳转失败，则传递的参数为 error
    const setupListeners = routeOrError =&gt; {
      history.setupListeners()
      handleInitialScroll(routeOrError)
    }
    /**
     * 此次的跳转是针对浏览器地址栏上的 url 进行跳转。
     * 地址栏可能是根路径: http://localhost:8080/；也可能是某个网页的路径 http://localhost:8080/user/info;
     */
    history.transitionTo(
      // 获取浏览器地址栏上的 url。
      // history.getCurrentLocation()： 返回的是访问地址字符串
      history.getCurrentLocation(),
      // 路径跳转成功的回调
      setupListeners,
      // 路径跳转失败的回调
      setupListeners
    )
  }

  // 在路由变化时，将新的路由对象同步到所有 Vue 实例中，从而触发 Vue 的重新渲染，展示新的页面内容
  history.listen(route =&gt; {
    this.apps.forEach(app =&gt; {
      app._route = route
    })
  })
}

" data-mdic-attach-content="" data-mdic-notify-id="j-notify-1701340876225-67533" data-mdic-notify-delay="2000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t='',e='')=&gt;new Promise((c,o)=&gt;{const n=document.createElement('textarea'),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display='block',setTimeout(()=&gt;{n.style.display='none'},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制代码</button></div></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br></div></div><p>这里分别调用了三个相关的方法<code>transitionTo</code>、<code>listen</code>、<code>setupListeners</code>，下面分别来看一下。</p> <h3 id="transitionto"><a href="#transitionto" class="header-anchor">#</a> transitionTo</h3> <p><code>transitionTo</code>方法位于<code>History</code>的定义中，用于跳转路由，该方法接收三个参数，第一个参数是路由对象，第二个参数是成功和失败的回</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// src/history/base.js</span>

<span class="token function">transitionTo</span> <span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">location</span><span class="token operator">:</span> RawLocation<span class="token punctuation">,</span>
  onComplete<span class="token operator">?</span><span class="token operator">:</span> Function<span class="token punctuation">,</span>
  onAbort<span class="token operator">?</span><span class="token operator">:</span> Function</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> route
  <span class="token comment">// catch redirect option https://github.com/vuejs/vue-router/issues/3201</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// 匹配路由</span>
    route <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>current<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>errorCbs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">cb</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">cb</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// Exception should still be thrown</span>
    <span class="token keyword">throw</span> e
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> prev <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>current
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">confirmTransition</span><span class="token punctuation">(</span>
    route<span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateRoute</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span>
      onComplete <span class="token operator">&amp;&amp;</span> <span class="token function">onComplete</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">ensureURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>afterHooks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">hook</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        hook <span class="token operator">&amp;&amp;</span> <span class="token function">hook</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> prev<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>

      <span class="token comment">// 执行ready回调</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>ready<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>ready <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>readyCbs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">cb</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">cb</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>onAbort<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">onAbort</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>ready<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Initial redirection should not mark the history as ready yet</span>
        <span class="token comment">// because it's triggered by the redirection instead</span>
        <span class="token comment">// https://github.com/vuejs/vue-router/issues/3225</span>
        <span class="token comment">// https://github.com/vuejs/vue-router/issues/3331</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isNavigationFailure</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> NavigationFailureType<span class="token punctuation">.</span>redirected<span class="token punctuation">)</span> <span class="token operator">||</span> prev <span class="token operator">!==</span> <span class="token constant">START</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>ready <span class="token operator">=</span> <span class="token boolean">true</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>readyErrorCbs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">cb</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">cb</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1701340876226-25340">成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="// src/history/base.js

transitionTo (
  location: RawLocation,
  onComplete?: Function,
  onAbort?: Function
) {
  let route
  // catch redirect option https://github.com/vuejs/vue-router/issues/3201
  try {
    // 匹配路由
    route = this.router.match(location, this.current)
  } catch (e) {
    this.errorCbs.forEach(cb =&gt; {
      cb(e)
    })
    // Exception should still be thrown
    throw e
  }
  const prev = this.current
  this.confirmTransition(
    route,
    () =&gt; {
      this.updateRoute(route)
      onComplete &amp;&amp; onComplete(route)
      this.ensureURL()
      this.router.afterHooks.forEach(hook =&gt; {
        hook &amp;&amp; hook(route, prev)
      })

      // 执行ready回调
      if (!this.ready) {
        this.ready = true
        this.readyCbs.forEach(cb =&gt; {
          cb(route)
        })
      }
    },
    err =&gt; {
      if (onAbort) {
        onAbort(err)
      }
      if (err &amp;&amp; !this.ready) {
        // Initial redirection should not mark the history as ready yet
        // because it's triggered by the redirection instead
        // https://github.com/vuejs/vue-router/issues/3225
        // https://github.com/vuejs/vue-router/issues/3331
        if (!isNavigationFailure(err, NavigationFailureType.redirected) || prev !== START) {
          this.ready = true
          this.readyErrorCbs.forEach(cb =&gt; {
            cb(err)
          })
        }
      }
    }
  )
}
" data-mdic-attach-content="" data-mdic-notify-id="j-notify-1701340876226-25340" data-mdic-notify-delay="2000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t='',e='')=&gt;new Promise((c,o)=&gt;{const n=document.createElement('textarea'),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display='block',setTimeout(()=&gt;{n.style.display='none'},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制代码</button></div></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br></div></div><p>上述代码较为简单，首先使用 <code>this.router.match(location, this.current)</code> 进行路由的匹配操作，匹配目标路由并得到相应的路由对象 <code>route</code>，并调用 <code>this.confirmTransition</code> 方法进行路由的过渡导航。</p> <h3 id="confirmtransition"><a href="#confirmtransition" class="header-anchor">#</a> confirmTransition</h3> <p><code>confirmTransition</code>方法同样位于<code>History</code>的定义中，用于跳转路由，该方法接收三个参数，第一个参数是路由对象，第二个参数是成功和失败的回调</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// src/history/base.js</span>
<span class="token comment">/**
 * 
 * @param {*} route 
 * @param {*} onComplete 完成回调
 * @param {*} onAbort 中止回调
 * @returns 
 */</span>
<span class="token function">confirmTransition</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">route</span><span class="token operator">:</span> Route<span class="token punctuation">,</span> <span class="token literal-property property">onComplete</span><span class="token operator">:</span> Function<span class="token punctuation">,</span> onAbort<span class="token operator">?</span><span class="token operator">:</span> Function</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> current <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>current
  <span class="token comment">// 将目标路由设置为正在处理的路由</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>pending <span class="token operator">=</span> route
  <span class="token comment">// 处理导航过程中的错误</span>
  <span class="token keyword">const</span> <span class="token function-variable function">abort</span> <span class="token operator">=</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// changed after adding errors with</span>
    <span class="token comment">// https://github.com/vuejs/vue-router/pull/3047 before that change,</span>
    <span class="token comment">// redirect and aborted navigation would produce an err == null</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isNavigationFailure</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>errorCbs<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果有错误回调函数，则执行错误回调</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>errorCbs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">cb</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">cb</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">warn</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">'uncaught error during route navigation:'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    onAbort <span class="token operator">&amp;&amp;</span> <span class="token function">onAbort</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> lastRouteIndex <span class="token operator">=</span> route<span class="token punctuation">.</span>matched<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>
  <span class="token keyword">const</span> lastCurrentIndex <span class="token operator">=</span> current<span class="token punctuation">.</span>matched<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>
  <span class="token comment">// 检查当前路由是否与目标路由相同</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    <span class="token function">isSameRoute</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> current<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    <span class="token comment">// 处理由于动态添加路由导致的差异</span>
    lastRouteIndex <span class="token operator">===</span> lastCurrentIndex <span class="token operator">&amp;&amp;</span>
    route<span class="token punctuation">.</span>matched<span class="token punctuation">[</span>lastRouteIndex<span class="token punctuation">]</span> <span class="token operator">===</span> current<span class="token punctuation">.</span>matched<span class="token punctuation">[</span>lastCurrentIndex<span class="token punctuation">]</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 相同路由导航，仅更新 URL 和哈希，然后中止导航并返回导航重复错误</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">ensureURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>route<span class="token punctuation">.</span>hash<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果有hash，可能是锚点，跳转到对应位置</span>
      <span class="token function">handleScroll</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">,</span> current<span class="token punctuation">,</span> route<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">abort</span><span class="token punctuation">(</span><span class="token function">createNavigationDuplicatedError</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> route<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 解析路由队列，确定要激活、更新和停用的组件</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> updated<span class="token punctuation">,</span> deactivated<span class="token punctuation">,</span> activated <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">resolveQueue</span><span class="token punctuation">(</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>current<span class="token punctuation">.</span>matched<span class="token punctuation">,</span>
    route<span class="token punctuation">.</span>matched
  <span class="token punctuation">)</span>

  <span class="token comment">// 构建导航钩子队列</span>
  <span class="token keyword">const</span> <span class="token literal-property property">queue</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span><span class="token operator">?</span>NavigationGuard<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>
    <span class="token comment">// 组件内离开守卫</span>
    <span class="token function">extractLeaveGuards</span><span class="token punctuation">(</span>deactivated<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// 全局前置守卫</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>beforeHooks<span class="token punctuation">,</span>
    <span class="token comment">// 组件内更新守卫</span>
    <span class="token function">extractUpdateHooks</span><span class="token punctuation">(</span>updated<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// 配置的路由进入守卫</span>
    activated<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">m</span> <span class="token operator">=&gt;</span> m<span class="token punctuation">.</span>beforeEnter<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// 异步组件的解析钩子函数</span>
    <span class="token function">resolveAsyncComponents</span><span class="token punctuation">(</span>activated<span class="token punctuation">)</span>
  <span class="token punctuation">)</span>

  <span class="token comment">// 定义迭代执行导航钩子的函数</span>
  <span class="token keyword">const</span> <span class="token function-variable function">iterator</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">hook</span><span class="token operator">:</span> NavigationGuard<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果导航已取消，直接返回导航中止错误</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>pending <span class="token operator">!==</span> route<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">abort</span><span class="token punctuation">(</span><span class="token function">createNavigationCancelledError</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> route<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// 执行导航守卫函数，并传入回调函数 next</span>
      <span class="token function">hook</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> current<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">to</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>to <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// next(false) -&gt; 中止导航并还原当前 URL</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">ensureURL</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
          <span class="token function">abort</span><span class="token punctuation">(</span><span class="token function">createNavigationAbortedError</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> route<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isError</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// next(err) -&gt; 处理错误并还原当前 URL</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">ensureURL</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
          <span class="token function">abort</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>
          <span class="token keyword">typeof</span> to <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">||</span>
          <span class="token punctuation">(</span><span class="token keyword">typeof</span> to <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span>
            <span class="token punctuation">(</span><span class="token keyword">typeof</span> to<span class="token punctuation">.</span>path <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> to<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// next('/') 或 next({ path: '/' }) -&gt; 重定向</span>
          <span class="token function">abort</span><span class="token punctuation">(</span><span class="token function">createNavigationRedirectedError</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> route<span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> to <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> to<span class="token punctuation">.</span>replace<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果重定向的是 replace 类型，则使用 replace 方法</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 否则，使用 push 方法进行导航</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// 确认导航，继续执行下一个导航守卫</span>
          <span class="token function">next</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 捕获导航守卫执行过程中的错误</span>
      <span class="token function">abort</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 执行导航钩子队列</span>
  <span class="token function">runQueue</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> iterator<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 等待异步组件解析完成后，提取组件内进入守卫</span>
    <span class="token keyword">const</span> enterGuards <span class="token operator">=</span> <span class="token function">extractEnterGuards</span><span class="token punctuation">(</span>activated<span class="token punctuation">)</span>
    <span class="token keyword">const</span> queue <span class="token operator">=</span> enterGuards<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>resolveHooks<span class="token punctuation">)</span>
    <span class="token function">runQueue</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> iterator<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果导航已取消，返回导航中止错误</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>pending <span class="token operator">!==</span> route<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">abort</span><span class="token punctuation">(</span><span class="token function">createNavigationCancelledError</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> route<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 导航过程结束，清空 pending 标记，并执行导航完成回调</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>pending <span class="token operator">=</span> <span class="token keyword">null</span>
      <span class="token function">onComplete</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span>
      <span class="token comment">// 在 Vue 的下一个更新周期执行路由进入后的处理</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>app<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>app<span class="token punctuation">.</span><span class="token function">$nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">handleRouteEntered</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1701340876226-87949">成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="// src/history/base.js
/**
 * 
 * @param {*} route 
 * @param {*} onComplete 完成回调
 * @param {*} onAbort 中止回调
 * @returns 
 */
confirmTransition (route: Route, onComplete: Function, onAbort?: Function) {
  const current = this.current
  // 将目标路由设置为正在处理的路由
  this.pending = route
  // 处理导航过程中的错误
  const abort = err =&gt; {
    // changed after adding errors with
    // https://github.com/vuejs/vue-router/pull/3047 before that change,
    // redirect and aborted navigation would produce an err == null
    if (!isNavigationFailure(err) &amp;&amp; isError(err)) {
      if (this.errorCbs.length) {
        // 如果有错误回调函数，则执行错误回调
        this.errorCbs.forEach(cb =&gt; {
          cb(err)
        })
      } else {
        if (process.env.NODE_ENV !== 'production') {
          warn(false, 'uncaught error during route navigation:')
        }
        console.error(err)
      }
    }
    onAbort &amp;&amp; onAbort(err)
  }
  const lastRouteIndex = route.matched.length - 1
  const lastCurrentIndex = current.matched.length - 1
  // 检查当前路由是否与目标路由相同
  if (
    isSameRoute(route, current) &amp;&amp;
    // 处理由于动态添加路由导致的差异
    lastRouteIndex === lastCurrentIndex &amp;&amp;
    route.matched[lastRouteIndex] === current.matched[lastCurrentIndex]
  ) {
    // 相同路由导航，仅更新 URL 和哈希，然后中止导航并返回导航重复错误
    this.ensureURL()
    if (route.hash) {
      // 如果有hash，可能是锚点，跳转到对应位置
      handleScroll(this.router, current, route, false)
    }
    return abort(createNavigationDuplicatedError(current, route))
  }

  // 解析路由队列，确定要激活、更新和停用的组件
  const { updated, deactivated, activated } = resolveQueue(
    this.current.matched,
    route.matched
  )

  // 构建导航钩子队列
  const queue: Array&lt;?NavigationGuard&gt; = [].concat(
    // 组件内离开守卫
    extractLeaveGuards(deactivated),
    // 全局前置守卫
    this.router.beforeHooks,
    // 组件内更新守卫
    extractUpdateHooks(updated),
    // 配置的路由进入守卫
    activated.map(m =&gt; m.beforeEnter),
    // 异步组件的解析钩子函数
    resolveAsyncComponents(activated)
  )

  // 定义迭代执行导航钩子的函数
  const iterator = (hook: NavigationGuard, next) =&gt; {
    // 如果导航已取消，直接返回导航中止错误
    if (this.pending !== route) {
      return abort(createNavigationCancelledError(current, route))
    }
    try {
      // 执行导航守卫函数，并传入回调函数 next
      hook(route, current, (to: any) =&gt; {
        if (to === false) {
          // next(false) -&gt; 中止导航并还原当前 URL
          this.ensureURL(true)
          abort(createNavigationAbortedError(current, route))
        } else if (isError(to)) {
          // next(err) -&gt; 处理错误并还原当前 URL
          this.ensureURL(true)
          abort(to)
        } else if (
          typeof to === 'string' ||
          (typeof to === 'object' &amp;&amp;
            (typeof to.path === 'string' || typeof to.name === 'string'))
        ) {
          // next('/') 或 next({ path: '/' }) -&gt; 重定向
          abort(createNavigationRedirectedError(current, route))
          if (typeof to === 'object' &amp;&amp; to.replace) {
            // 如果重定向的是 replace 类型，则使用 replace 方法
            this.replace(to)
          } else {
            // 否则，使用 push 方法进行导航
            this.push(to)
          }
        } else {
          // 确认导航，继续执行下一个导航守卫
          next(to)
        }
      })
    } catch (e) {
      // 捕获导航守卫执行过程中的错误
      abort(e)
    }
  }

  // 执行导航钩子队列
  runQueue(queue, iterator, () =&gt; {
    // 等待异步组件解析完成后，提取组件内进入守卫
    const enterGuards = extractEnterGuards(activated)
    const queue = enterGuards.concat(this.router.resolveHooks)
    runQueue(queue, iterator, () =&gt; {
      // 如果导航已取消，返回导航中止错误
      if (this.pending !== route) {
        return abort(createNavigationCancelledError(current, route))
      }
      // 导航过程结束，清空 pending 标记，并执行导航完成回调
      this.pending = null
      onComplete(route)
      // 在 Vue 的下一个更新周期执行路由进入后的处理
      if (this.router.app) {
        this.router.app.$nextTick(() =&gt; {
          handleRouteEntered(route)
        })
      }
    })
  })
}
" data-mdic-attach-content="" data-mdic-notify-id="j-notify-1701340876226-87949" data-mdic-notify-delay="2000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t='',e='')=&gt;new Promise((c,o)=&gt;{const n=document.createElement('textarea'),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display='block',setTimeout(()=&gt;{n.style.display='none'},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制代码</button></div></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br></div></div><p>上述代码较长，我们梳理下整体逻辑</p> <ol><li>将目标路由信息 <code>route</code> 设置为 <code>this.pending</code>，表示当前正在处理这个路由导航。</li> <li>判断当前路由 <code>current</code> 是否与目标路由 <code>route</code> 相同：
<ul><li>如果两者相同，则说明是相同路由导航（例如，再次点击当前路由链接），则不执行导航操作，直接调用 <code>this.ensureURL()</code> 来确保 URL 的正确性，并返回一个导航重复错误 <code>createNavigationDuplicatedError</code>。</li> <li>如果两者不相同，继续进行下一步的导航操作。</li></ul></li> <li>解析路由队列：
使用 <code>resolveQueue</code> 方法来解析出需要激活的路由组件 (<code>activated</code>)、需要更新的路由组件 (<code>updated</code>) 以及需要停用的路由组件 (<code>deactivated</code>)。</li> <li>构建导航钩子队列：
根据路由解析结果，构建一个由导航守卫函数组成的导航钩子队列 <code>queue</code>。这个队列包括以下类型的钩子函数：
<ul><li>组件内离开守卫 (<code>beforeRouteLeave</code>)</li> <li>全局前置守卫 (<code>beforeEach</code>)</li> <li>重用的组件里更新守卫 (<code>beforeRouteUpdate</code>)</li> <li>配置的路由进入守卫 (<code>beforeEnter</code>)</li> <li>异步组件的解析钩子函数</li></ul></li> <li>迭代执行导航钩子：
使用 <code>runQueue</code> 方法来依次迭代执行导航钩子队列 <code>queue</code> 中的函数。这里的迭代过程会传入 <code>hook</code> 和 <code>next</code> 两个参数，<code>hook</code> 表示当前的导航守卫函数，<code>next</code> 是导航守卫函数执行完毕后的回调函数。在迭代过程中，如果发现 <code>this.pending</code> 已经变化，表示导航被取消，将会返回导航取消错误 <code>createNavigationCancelledError</code>。</li> <li>在迭代过程中，导航守卫函数 <code>hook</code> 中有多种可能的执行结果：
<ul><li><code>next(false)</code>: 表示导航被中止，将会触发导航中止错误 <code>createNavigationAbortedError</code>。</li> <li><code>next('/')</code> 或 <code>next({ path: '/' })</code>: 表示进行重定向，将会触发导航重定向错误 <code>createNavigationRedirectedError</code>中止导航，然后执行 <code>this.push(to)</code> 或 <code>this.replace(to)</code> 来进行重定向操作。</li> <li><code>next(to)</code>: 表示继续导航，将执行 <code>next(to)</code> 来继续下一个导航守卫函数。</li></ul></li> <li>在执行完所有导航守卫函数后，执行 <code>onComplete(route)</code>，表示导航过程已完成。</li> <li>如果 Vue Router 的实例 <code>this.router.app</code> 存在，表示是在 Vue 应用中使用 Vue Router，将在 Vue 的下一个更新周期调用 <code>handleRouteEntered(route)</code>，用于处理路由进入后的操作。</li></ol> <p>有些同学，可能对于判断当前路由 <code>current</code> 是否与目标路由 <code>route</code> 相同的逻辑不太明白，这里解释下</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> lastRouteIndex <span class="token operator">=</span> route<span class="token punctuation">.</span>matched<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>
<span class="token keyword">const</span> lastCurrentIndex <span class="token operator">=</span> current<span class="token punctuation">.</span>matched<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>
<span class="token comment">// 检查当前路由是否与目标路由相同</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>
  <span class="token function">isSameRoute</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> current<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
  <span class="token comment">// 处理由于动态添加路由导致的差异</span>
  lastRouteIndex <span class="token operator">===</span> lastCurrentIndex <span class="token operator">&amp;&amp;</span>
  route<span class="token punctuation">.</span>matched<span class="token punctuation">[</span>lastRouteIndex<span class="token punctuation">]</span> <span class="token operator">===</span> current<span class="token punctuation">.</span>matched<span class="token punctuation">[</span>lastCurrentIndex<span class="token punctuation">]</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1701340876227-75729">成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="const lastRouteIndex = route.matched.length - 1
const lastCurrentIndex = current.matched.length - 1
// 检查当前路由是否与目标路由相同
if (
  isSameRoute(route, current) &amp;&amp;
  // 处理由于动态添加路由导致的差异
  lastRouteIndex === lastCurrentIndex &amp;&amp;
  route.matched[lastRouteIndex] === current.matched[lastCurrentIndex]
) {
  // ...
}
" data-mdic-attach-content="" data-mdic-notify-id="j-notify-1701340876227-75729" data-mdic-notify-delay="2000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t='',e='')=&gt;new Promise((c,o)=&gt;{const n=document.createElement('textarea'),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display='block',setTimeout(()=&gt;{n.style.display='none'},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制代码</button></div></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><ol><li><p><code>isSameRoute(route, current)</code>: 这是一个函数调用，用于检查两个路由是否相同。在 Vue Router 中，两个路由被认为是相同的，当且仅当它们具有相同的路径、参数和查询参数。如果两个路由相同，就表示导航到同一个路由，此时不需要进行实际的导航操作，只需更新 URL 和哈希部分即可。</p></li> <li><p><code>lastRouteIndex === lastCurrentIndex &amp;&amp; route.matched[lastRouteIndex] === current.matched[lastCurrentIndex]</code>: 这部分代码主要是用于处理动态添加路由的情况。在 Vue Router 中，路由可以动态地添加到路由映射表中，这时可能会导致 <code>route.matched</code> 数组的长度与 <code>current.matched</code> 数组的长度不一致。</p> <ul><li><code>lastRouteIndex</code>: 表示目标路由 <code>route</code> 的 <code>matched</code> 数组的最后一个索引。</li> <li><code>lastCurrentIndex</code>: 表示当前路由 <code>current</code> 的 <code>matched</code> 数组的最后一个索引。</li></ul> <p>当两者的索引相同，并且 <code>route.matched[lastRouteIndex] === current.matched[lastCurrentIndex]</code> 时，表示目标路由 <code>route</code> 在动态添加路由之前和之后都能够找到匹配的路由配置，因此可以认为是同一个路由。在这种情况下，也不需要进行实际的导航操作，只需更新 URL 和哈希部分。</p></li></ol> <p>综合以上两个条件，当两个路由满足相同路由条件，并且目标路由在动态添加路由之前和之后都能找到匹配的路由配置时，就会进入这个条件分支，执行更新 URL 和哈希部分，并中止导航操作，返回导航重复错误。这样可以避免重复执行路由的激活和更新操作，提高导航的效率。</p> <h3 id="listen"><a href="#listen" class="header-anchor">#</a> listen</h3> <p><code>listen</code> 方法位于<code>History</code>的定义中，用于注册一个回调函数，使之监听路由变化事件</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// src/history/base.js</span>
<span class="token function">listen</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">cb</span><span class="token operator">:</span> Function</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>cb <span class="token operator">=</span> cb
<span class="token punctuation">}</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1701340876227-45451">成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="// src/history/base.js
listen (cb: Function) {
  this.cb = cb
}
" data-mdic-attach-content="" data-mdic-notify-id="j-notify-1701340876227-45451" data-mdic-notify-delay="2000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t='',e='')=&gt;new Promise((c,o)=&gt;{const n=document.createElement('textarea'),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display='block',setTimeout(()=&gt;{n.style.display='none'},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制代码</button></div></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>代码如上，<code>listen</code> 方法会将传入的回调函数 <code>cb</code> 保存在 <code>this.cb</code> 属性中。在路由发生变化时，Vue Router 会调用这个回调函数，并将相关的路由信息传递给它，以便在回调函数中处理路由变化的逻辑。</p> <h3 id="setuplisteners"><a href="#setuplisteners" class="header-anchor">#</a> setupListeners</h3> <p><code>setupListeners</code>方法位于<code>HTML5History</code>的定义中。这个方法用于设置路由变化的监听器，并在路由变化时触发相应的处理逻辑</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// src/history/html5.js</span>
<span class="token comment">// 设置路由监听器，用于处理浏览器地址变化事件</span>
<span class="token function">setupListeners</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 检查是否已设置监听器，避免重复设置</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>listeners<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 当前 Vue Router 实例</span>
  <span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>router
  <span class="token comment">// 期望的滚动行为</span>
  <span class="token keyword">const</span> expectScroll <span class="token operator">=</span> router<span class="token punctuation">.</span>options<span class="token punctuation">.</span>scrollBehavior
  <span class="token comment">// 是否支持滚动行为</span>
  <span class="token keyword">const</span> supportsScroll <span class="token operator">=</span> supportsPushState <span class="token operator">&amp;&amp;</span> expectScroll

  <span class="token comment">// 添加滚动行为的监听器，如果支持滚动行为</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>supportsScroll<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>listeners<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">setupScroll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 定义处理路由变化事件的回调函数</span>
  <span class="token keyword">const</span> <span class="token function-variable function">handleRoutingEvent</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> current <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>current

    <span class="token comment">// Avoiding first `popstate` event dispatched in some browsers but first</span>
    <span class="token comment">// history route not updated since async guard at the same time.</span>
    <span class="token comment">// 获取当前地址信息</span>
    <span class="token keyword">const</span> location <span class="token operator">=</span> <span class="token function">getLocation</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>base<span class="token punctuation">)</span>

    <span class="token comment">// 避免处理浏览器首次 `popstate` 事件时，路由状态尚未更新</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>current <span class="token operator">===</span> <span class="token constant">START</span> <span class="token operator">&amp;&amp;</span> location <span class="token operator">===</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_startLocation<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 进行路由转换</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">transitionTo</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> <span class="token parameter">route</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果支持滚动行为，则处理滚动</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>supportsScroll<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">handleScroll</span><span class="token punctuation">(</span>router<span class="token punctuation">,</span> route<span class="token punctuation">,</span> current<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// 添加 `popstate` 事件监听器，并将其添加到 listeners 数组中</span>
  window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'popstate'</span><span class="token punctuation">,</span> handleRoutingEvent<span class="token punctuation">)</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>listeners<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'popstate'</span><span class="token punctuation">,</span> handleRoutingEvent<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1701340876227-83382">成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="// src/history/html5.js
// 设置路由监听器，用于处理浏览器地址变化事件
setupListeners () {
  // 检查是否已设置监听器，避免重复设置
  if (this.listeners.length &gt; 0) {
    return
  }
  // 当前 Vue Router 实例
  const router = this.router
  // 期望的滚动行为
  const expectScroll = router.options.scrollBehavior
  // 是否支持滚动行为
  const supportsScroll = supportsPushState &amp;&amp; expectScroll

  // 添加滚动行为的监听器，如果支持滚动行为
  if (supportsScroll) {
    this.listeners.push(setupScroll())
  }

  // 定义处理路由变化事件的回调函数
  const handleRoutingEvent = () =&gt; {
    const current = this.current

    // Avoiding first `popstate` event dispatched in some browsers but first
    // history route not updated since async guard at the same time.
    // 获取当前地址信息
    const location = getLocation(this.base)

    // 避免处理浏览器首次 `popstate` 事件时，路由状态尚未更新
    if (this.current === START &amp;&amp; location === this._startLocation) {
      return
    }

    // 进行路由转换
    this.transitionTo(location, route =&gt; {
      // 如果支持滚动行为，则处理滚动
      if (supportsScroll) {
        handleScroll(router, route, current, true)
      }
    })
  }
  
  // 添加 `popstate` 事件监听器，并将其添加到 listeners 数组中
  window.addEventListener('popstate', handleRoutingEvent)
  this.listeners.push(() =&gt; {
    window.removeEventListener('popstate', handleRoutingEvent)
  })
}
" data-mdic-attach-content="" data-mdic-notify-id="j-notify-1701340876227-83382" data-mdic-notify-delay="2000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t='',e='')=&gt;new Promise((c,o)=&gt;{const n=document.createElement('textarea'),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display='block',setTimeout(()=&gt;{n.style.display='none'},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制代码</button></div></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><ol><li><p>检查是否已设置监听器：</p> <p>首先，检查当前的 <code>this.listeners</code> 数组是否已经有监听器。如果已经设置过监听器，则直接返回，避免重复设置。</p></li> <li><p>准备相关信息：</p> <p>获取当前 Vue Router 实例 <code>this.router</code>，并根据配置中的 <code>scrollBehavior</code> 期望值，判断是否支持滚动行为。如果浏览器支持推送状态（<code>supportsPushState</code> 为 <code>true</code>）并且 <code>scrollBehavior</code> 存在，则支持滚动行为。</p></li> <li><p>添加路由变化事件监听器：</p> <p>如果支持滚动行为，调用 <code>setupScroll()</code> 方法来设置滚动行为的监听器，并将其添加到 <code>this.listeners</code> 数组中。</p></li> <li><p>定义 <code>handleRoutingEvent</code> 方法：</p> <p>这个方法是处理路由变化事件的回调函数。在这个方法中，首先获取当前的路由状态 <code>this.current</code> 和当前地址 <code>location</code>，然后检查当前路由状态是否为初始化状态 <code>START</code>，同时比较当前地址和初始地址是否相同。如果相同，则表示浏览器发出的首个 <code>popstate</code> 事件，但路由状态尚未被更新，因此直接返回，不执行后续逻辑。</p></li> <li><p>添加 <code>popstate</code> 事件监听器：</p> <p>在这里，将 <code>handleRoutingEvent</code> 方法添加为 <code>popstate</code> 事件的回调函数，用于处理浏览器的前进、后退等操作。然后将这个监听器回调函数也添加到 <code>this.listeners</code> 数组中，以便在后续需要移除监听器时使用。</p></li></ol> <h2 id="常见方法"><a href="#常见方法" class="header-anchor">#</a> 常见方法</h2> <p>分析完实例化和初始化后，我们分析下我们工作中一些常见的方法</p> <h3 id="push"><a href="#push" class="header-anchor">#</a> push</h3> <p>我们在开发中的调用的<code>router.push</code>方法，实际上就是<code>VueRouter</code>类中的<code>push</code>方法。这个方法用于执行路由的推入导航操作，即将用户导航到指定的目标路由</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// src/router.js</span>
<span class="token function">push</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">location</span><span class="token operator">:</span> RawLocation<span class="token punctuation">,</span> onComplete<span class="token operator">?</span><span class="token operator">:</span> Function<span class="token punctuation">,</span> onAbort<span class="token operator">?</span><span class="token operator">:</span> Function</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// $flow-disable-line</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>onComplete <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>onAbort <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> Promise <span class="token operator">!==</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> onComplete<span class="token punctuation">,</span> onAbort<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1701340876228-26079">成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="// src/router.js
push (location: RawLocation, onComplete?: Function, onAbort?: Function) {
  // $flow-disable-line
  if (!onComplete &amp;&amp; !onAbort &amp;&amp; typeof Promise !== 'undefined') {
    return new Promise((resolve, reject) =&gt; {
      this.history.push(location, resolve, reject)
    })
  } else {
    this.history.push(location, onComplete, onAbort)
  }
}
" data-mdic-attach-content="" data-mdic-notify-id="j-notify-1701340876228-26079" data-mdic-notify-delay="2000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t='',e='')=&gt;new Promise((c,o)=&gt;{const n=document.createElement('textarea'),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display='block',setTimeout(()=&gt;{n.style.display='none'},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制代码</button></div></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>上述代码可以看出，<code>push</code>方法的实现主要依赖于<code>this.history.push</code>，该方法位于<code>HTML5History</code>的定义中</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">push</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">location</span><span class="token operator">:</span> RawLocation<span class="token punctuation">,</span> onComplete<span class="token operator">?</span><span class="token operator">:</span> Function<span class="token punctuation">,</span> onAbort<span class="token operator">?</span><span class="token operator">:</span> Function</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token literal-property property">current</span><span class="token operator">:</span> fromRoute <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">transitionTo</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> <span class="token parameter">route</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 添加新路由地址到浏览器历史中</span>
    <span class="token function">pushState</span><span class="token punctuation">(</span><span class="token function">cleanPath</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>base <span class="token operator">+</span> route<span class="token punctuation">.</span>fullPath<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 处理滚动相关</span>
    <span class="token function">handleScroll</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">,</span> route<span class="token punctuation">,</span> fromRoute<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token comment">// 执行成功回调</span>
    onComplete <span class="token operator">&amp;&amp;</span> <span class="token function">onComplete</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> onAbort<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1701340876228-16756">成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="push (location: RawLocation, onComplete?: Function, onAbort?: Function) {
  const { current: fromRoute } = this
  this.transitionTo(location, route =&gt; {
    // 添加新路由地址到浏览器历史中
    pushState(cleanPath(this.base + route.fullPath))
    // 处理滚动相关
    handleScroll(this.router, route, fromRoute, false)
    // 执行成功回调
    onComplete &amp;&amp; onComplete(route)
  }, onAbort)
}
" data-mdic-attach-content="" data-mdic-notify-id="j-notify-1701340876228-16756" data-mdic-notify-delay="2000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t='',e='')=&gt;new Promise((c,o)=&gt;{const n=document.createElement('textarea'),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display='block',setTimeout(()=&gt;{n.style.display='none'},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制代码</button></div></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>在这个方法中，主要的操作是调用 <code>this.transitionTo()</code> 方法进行路由的过渡导航。<code>transitionTo</code> 方法会处理路由的匹配和组件渲染，并在导航完成后执行回调函数。这个方法将触发路由的变化，并处理浏览器地址的变化。</p> <p>接着，<code>pushState()</code> 方法会使用 <code>HTML5 History API</code> 来将新的路由地址添加到浏览器历史记录中。这样用户就能通过浏览器的前进和后退按钮导航到不同的路由。</p> <p>最后，在导航完成后，会执行 <code>handleScroll()</code> 方法来处理滚动行为，确保页面在切换路由后能够正确地滚动到指定位置。</p> <p>其中<code>pushState</code>方法的定义在<code>src/util/push-state.js</code>中定义，有关<code>push</code>的部分代码如下</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// push 方式跳转新路径，会在 history 中记录。</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">pushState</span> <span class="token punctuation">(</span><span class="token parameter">url<span class="token operator">?</span><span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 保存当前页面滚动位置</span>
  <span class="token function">saveScrollPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// try...catch the pushState call to get around Safari</span>
  <span class="token comment">// DOM Exception 18 where it limits to 100 pushState calls</span>
  <span class="token keyword">const</span> history <span class="token operator">=</span> window<span class="token punctuation">.</span>history
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果是跳转，使用 history 的 push 方法</span>
    history<span class="token punctuation">.</span><span class="token function">pushState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token function">setStateKey</span><span class="token punctuation">(</span><span class="token function">genStateKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果抛出了异常，则表示栈已经到了最大值，不能push了。</span>
    <span class="token comment">// 使用 location.assign 也可以用来跳转网址，且 assign 会添加记录到浏览历史，点击后退可以返回到之前页面。</span>
    window<span class="token punctuation">.</span>location<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1701340876228-90532">成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="// push 方式跳转新路径，会在 history 中记录。
export function pushState (url?: string) {
  // 保存当前页面滚动位置
  saveScrollPosition()
  // try...catch the pushState call to get around Safari
  // DOM Exception 18 where it limits to 100 pushState calls
  const history = window.history
  try {
    // 如果是跳转，使用 history 的 push 方法
    history.pushState({ key: setStateKey(genStateKey()) }, '', url)
  } catch (e) {
    // 如果抛出了异常，则表示栈已经到了最大值，不能push了。
    // 使用 location.assign 也可以用来跳转网址，且 assign 会添加记录到浏览历史，点击后退可以返回到之前页面。
    window.location.assign(url)
  }
}
" data-mdic-attach-content="" data-mdic-notify-id="j-notify-1701340876228-90532" data-mdic-notify-delay="2000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t='',e='')=&gt;new Promise((c,o)=&gt;{const n=document.createElement('textarea'),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display='block',setTimeout(()=&gt;{n.style.display='none'},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制代码</button></div></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>很明显，<code>push</code>跳转的最终方法是调用了<code>window.history.pushState</code>方法进行跳转的</p> <h3 id="replace"><a href="#replace" class="header-anchor">#</a> replace</h3> <p>我们在开发中的调用的<code>router.replace</code>方法，调用的也是<code>VueRouter</code>类中的<code>replace</code>方法。这个方法用于执行的替换导航操作</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 重定向到新的页面。replace 会替换掉当前页面所在的浏览器历史记录</span>
<span class="token function">replace</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">location</span><span class="token operator">:</span> RawLocation<span class="token punctuation">,</span> onComplete<span class="token operator">?</span><span class="token operator">:</span> Function<span class="token punctuation">,</span> onAbort<span class="token operator">?</span><span class="token operator">:</span> Function</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// $flow-disable-line</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>onComplete <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>onAbort <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> Promise <span class="token operator">!==</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> onComplete<span class="token punctuation">,</span> onAbort<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1701340876228-90742">成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="// 重定向到新的页面。replace 会替换掉当前页面所在的浏览器历史记录
replace (location: RawLocation, onComplete?: Function, onAbort?: Function) {
  // $flow-disable-line
  if (!onComplete &amp;&amp; !onAbort &amp;&amp; typeof Promise !== 'undefined') {
    return new Promise((resolve, reject) =&gt; {
      this.history.replace(location, resolve, reject)
    })
  } else {
    this.history.replace(location, onComplete, onAbort)
  }
}
" data-mdic-attach-content="" data-mdic-notify-id="j-notify-1701340876228-90742" data-mdic-notify-delay="2000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t='',e='')=&gt;new Promise((c,o)=&gt;{const n=document.createElement('textarea'),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display='block',setTimeout(()=&gt;{n.style.display='none'},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制代码</button></div></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>上述代码可以看出，<code>replace</code>方法的实现主要依赖于<code>this.history.replace</code>，该方法位于<code>HTML5History</code>的定义中</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">replace</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">location</span><span class="token operator">:</span> RawLocation<span class="token punctuation">,</span> onComplete<span class="token operator">?</span><span class="token operator">:</span> Function<span class="token punctuation">,</span> onAbort<span class="token operator">?</span><span class="token operator">:</span> Function</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token literal-property property">current</span><span class="token operator">:</span> fromRoute <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">transitionTo</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> <span class="token parameter">route</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 新的路由地址直接替换当前的浏览器历史记录</span>
    <span class="token function">replaceState</span><span class="token punctuation">(</span><span class="token function">cleanPath</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>base <span class="token operator">+</span> route<span class="token punctuation">.</span>fullPath<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 处理滚动相关</span>
    <span class="token function">handleScroll</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">,</span> route<span class="token punctuation">,</span> fromRoute<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token comment">// 执行成功回调</span>
    onComplete <span class="token operator">&amp;&amp;</span> <span class="token function">onComplete</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> onAbort<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1701340876228-54452">成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="replace (location: RawLocation, onComplete?: Function, onAbort?: Function) {
  const { current: fromRoute } = this
  this.transitionTo(location, route =&gt; {
    // 新的路由地址直接替换当前的浏览器历史记录
    replaceState(cleanPath(this.base + route.fullPath))
    // 处理滚动相关
    handleScroll(this.router, route, fromRoute, false)
    // 执行成功回调
    onComplete &amp;&amp; onComplete(route)
  }, onAbort)
}
" data-mdic-attach-content="" data-mdic-notify-id="j-notify-1701340876228-54452" data-mdic-notify-delay="2000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t='',e='')=&gt;new Promise((c,o)=&gt;{const n=document.createElement('textarea'),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display='block',setTimeout(()=&gt;{n.style.display='none'},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制代码</button></div></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><code>replace</code>的实现跟<code>push</code>有些类似，唯一不同的是，改为调用的<code>replaceState</code>方法，我们继续看<code>replaceState</code>方法的定义</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// replace 方式跳转新路径，不会在 history 中记录</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">replaceState</span> <span class="token punctuation">(</span><span class="token parameter">url<span class="token operator">?</span><span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">pushState</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1701340876229-92476">成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="// replace 方式跳转新路径，不会在 history 中记录
export function replaceState (url?: string) {
  pushState(url, true)
}
" data-mdic-attach-content="" data-mdic-notify-id="j-notify-1701340876229-92476" data-mdic-notify-delay="2000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t='',e='')=&gt;new Promise((c,o)=&gt;{const n=document.createElement('textarea'),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display='block',setTimeout(()=&gt;{n.style.display='none'},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制代码</button></div></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>殊途同归，<code>replaceState</code>调用的最后还是<code>pushState</code>，有关<code>replace</code>的部分代码如下</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">pushState</span> <span class="token punctuation">(</span><span class="token parameter">url<span class="token operator">?</span><span class="token operator">:</span> string<span class="token punctuation">,</span> replace<span class="token operator">?</span><span class="token operator">:</span> boolean</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 保存当前页面滚动位置</span>
  <span class="token function">saveScrollPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// try...catch the pushState call to get around Safari</span>
  <span class="token comment">// DOM Exception 18 where it limits to 100 pushState calls</span>
  <span class="token keyword">const</span> history <span class="token operator">=</span> window<span class="token punctuation">.</span>history
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// 保存之前 history 的 state</span>
      <span class="token keyword">const</span> stateCopy <span class="token operator">=</span> <span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> history<span class="token punctuation">.</span>state<span class="token punctuation">)</span>
      stateCopy<span class="token punctuation">.</span>key <span class="token operator">=</span> <span class="token function">getStateKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      history<span class="token punctuation">.</span><span class="token function">replaceState</span><span class="token punctuation">(</span>stateCopy<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span>location<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1701340876229-62862">成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="export function pushState (url?: string, replace?: boolean) {
  // 保存当前页面滚动位置
  saveScrollPosition()
  // try...catch the pushState call to get around Safari
  // DOM Exception 18 where it limits to 100 pushState calls
  const history = window.history
  try {
      // 保存之前 history 的 state
      const stateCopy = extend({}, history.state)
      stateCopy.key = getStateKey()
      history.replaceState(stateCopy, '', url)
  } catch (e) {
    window.location.replace(url)
  }
}
" data-mdic-attach-content="" data-mdic-notify-id="j-notify-1701340876229-62862" data-mdic-notify-delay="2000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t='',e='')=&gt;new Promise((c,o)=&gt;{const n=document.createElement('textarea'),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display='block',setTimeout(()=&gt;{n.style.display='none'},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制代码</button></div></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>很明显，<code>push</code>跳转的最终方法是调用了<code>window.history.replaceState</code>方法，并且将当前历史的自定义数据传入后进行跳转的</p> <h3 id="go"><a href="#go" class="header-anchor">#</a> go</h3> <p>我们在开发中的调用的<code>router.go</code>方法，调用的也是<code>VueRouter</code>类中的<code>go</code>方法。这个方法用于在浏览器历史记录中移动</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">go</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">n</span><span class="token operator">:</span> number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function">go</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1701340876229-15723">成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="go (n: number) {
  this.history.go(n)
}
" data-mdic-attach-content="" data-mdic-notify-id="j-notify-1701340876229-15723" data-mdic-notify-delay="2000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t='',e='')=&gt;new Promise((c,o)=&gt;{const n=document.createElement('textarea'),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display='block',setTimeout(()=&gt;{n.style.display='none'},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制代码</button></div></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>上述代码可以看出，<code>back</code>方法的实现主要依赖于<code>this.history.go</code>，该方法位于<code>HTML5History</code>的定义中</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">go</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">n</span><span class="token operator">:</span> number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  window<span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function">go</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1701340876229-73081">成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="go (n: number) {
  window.history.go(n)
}
" data-mdic-attach-content="" data-mdic-notify-id="j-notify-1701340876229-73081" data-mdic-notify-delay="2000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t='',e='')=&gt;new Promise((c,o)=&gt;{const n=document.createElement('textarea'),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display='block',setTimeout(()=&gt;{n.style.display='none'},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制代码</button></div></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>清晰明了，<code>go</code>方法就是依赖<code>window.history.go</code>实现的</p> <h3 id="back"><a href="#back" class="header-anchor">#</a> back</h3> <p>我们在开发中的调用的<code>router.back</code>方法，调用的也是<code>VueRouter</code>类中的<code>back</code>方法。这个方法用于执行浏览器回退操作</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">back</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">go</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1701340876229-88729">成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="back () {
  this.go(-1)
}
" data-mdic-attach-content="" data-mdic-notify-id="j-notify-1701340876229-88729" data-mdic-notify-delay="2000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t='',e='')=&gt;new Promise((c,o)=&gt;{const n=document.createElement('textarea'),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display='block',setTimeout(()=&gt;{n.style.display='none'},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制代码</button></div></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>上述代码可以看出，<code>back</code>方法的实现主要依赖于<code>this.go</code>，该方法我们上面分析过，不赘述</p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>Vue Route 在<code>history</code>模式下，是利用浏览器原生提供的<code>API</code>，路由发生变更时，通过<code>history.pushState</code>和<code>history.replaceState</code>等方法来改变页面的<code>url</code>。</p> <p>同时监听<code>popstate</code>方法，当使用浏览器前进后退按钮发生变更时，切换为对应的组件，从而实现整个页面路由的切换。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/vueRouter3/mode/" class="prev router-link-active">
        简介
      </a></span> <span class="next"><a href="/vueRouter3/mode/hash.html">
        Hash模式
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.ad3c3e04.js" defer></script><script src="/assets/js/2.88c18509.js" defer></script><script src="/assets/js/1.d4c099ff.js" defer></script><script src="/assets/js/94.ffcef793.js" defer></script>
  </body>
</html>
