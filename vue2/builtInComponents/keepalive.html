<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>keep-alive | 前端源码解读</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="前端源码解读文档;使用过程中如碰到问题，请到Github进行提问。 https://github.com/CrayonPig/originCodeCommit">
    
    <link rel="preload" href="/assets/css/0.styles.96eb8417.css" as="style"><link rel="preload" href="/assets/js/app.ea1ce679.js" as="script"><link rel="preload" href="/assets/js/2.88c18509.js" as="script"><link rel="preload" href="/assets/js/1.d4c099ff.js" as="script"><link rel="preload" href="/assets/js/28.6d1471fa.js" as="script"><link rel="prefetch" href="/assets/js/10.b14aa6d6.js"><link rel="prefetch" href="/assets/js/100.e5117e52.js"><link rel="prefetch" href="/assets/js/101.7d9b8e54.js"><link rel="prefetch" href="/assets/js/102.673b09d1.js"><link rel="prefetch" href="/assets/js/103.5a795203.js"><link rel="prefetch" href="/assets/js/104.9f6370e2.js"><link rel="prefetch" href="/assets/js/105.d78f9107.js"><link rel="prefetch" href="/assets/js/106.5ed6eb5c.js"><link rel="prefetch" href="/assets/js/107.f8cdf13d.js"><link rel="prefetch" href="/assets/js/108.8b5cf6dc.js"><link rel="prefetch" href="/assets/js/109.c819fc45.js"><link rel="prefetch" href="/assets/js/11.9fe1d85e.js"><link rel="prefetch" href="/assets/js/110.956bb884.js"><link rel="prefetch" href="/assets/js/111.7bbf9c06.js"><link rel="prefetch" href="/assets/js/112.6e6d5416.js"><link rel="prefetch" href="/assets/js/113.08a53aff.js"><link rel="prefetch" href="/assets/js/114.655809f4.js"><link rel="prefetch" href="/assets/js/115.530eeb7a.js"><link rel="prefetch" href="/assets/js/116.0da06075.js"><link rel="prefetch" href="/assets/js/117.793d920f.js"><link rel="prefetch" href="/assets/js/12.86508e15.js"><link rel="prefetch" href="/assets/js/13.b420db5d.js"><link rel="prefetch" href="/assets/js/14.4a65991d.js"><link rel="prefetch" href="/assets/js/15.42e542bb.js"><link rel="prefetch" href="/assets/js/16.42d8df26.js"><link rel="prefetch" href="/assets/js/17.11d996a2.js"><link rel="prefetch" href="/assets/js/18.6f8f0eec.js"><link rel="prefetch" href="/assets/js/19.67e71589.js"><link rel="prefetch" href="/assets/js/20.9f10fe7c.js"><link rel="prefetch" href="/assets/js/21.ea2c4577.js"><link rel="prefetch" href="/assets/js/22.ba4edf56.js"><link rel="prefetch" href="/assets/js/23.f26baabe.js"><link rel="prefetch" href="/assets/js/24.f05045eb.js"><link rel="prefetch" href="/assets/js/25.7b759676.js"><link rel="prefetch" href="/assets/js/26.db0958d5.js"><link rel="prefetch" href="/assets/js/27.ce419d8c.js"><link rel="prefetch" href="/assets/js/29.92daf9dc.js"><link rel="prefetch" href="/assets/js/3.47d5fbb2.js"><link rel="prefetch" href="/assets/js/30.c1095425.js"><link rel="prefetch" href="/assets/js/31.16ad4f1d.js"><link rel="prefetch" href="/assets/js/32.8ca629fd.js"><link rel="prefetch" href="/assets/js/33.a02b6830.js"><link rel="prefetch" href="/assets/js/34.258e2bbf.js"><link rel="prefetch" href="/assets/js/35.a1c6adf9.js"><link rel="prefetch" href="/assets/js/36.2118f607.js"><link rel="prefetch" href="/assets/js/37.adacdfef.js"><link rel="prefetch" href="/assets/js/38.3fee0ddb.js"><link rel="prefetch" href="/assets/js/39.c5251a61.js"><link rel="prefetch" href="/assets/js/4.37747ac1.js"><link rel="prefetch" href="/assets/js/40.a77724f2.js"><link rel="prefetch" href="/assets/js/41.a629b97c.js"><link rel="prefetch" href="/assets/js/42.b4ce787e.js"><link rel="prefetch" href="/assets/js/43.ce5d8ba2.js"><link rel="prefetch" href="/assets/js/44.094ffb5c.js"><link rel="prefetch" href="/assets/js/45.97454c76.js"><link rel="prefetch" href="/assets/js/46.0fc31968.js"><link rel="prefetch" href="/assets/js/47.938152f8.js"><link rel="prefetch" href="/assets/js/48.c73f6571.js"><link rel="prefetch" href="/assets/js/49.5af79632.js"><link rel="prefetch" href="/assets/js/5.094ae013.js"><link rel="prefetch" href="/assets/js/50.81656966.js"><link rel="prefetch" href="/assets/js/51.69128bcb.js"><link rel="prefetch" href="/assets/js/52.5c9c2105.js"><link rel="prefetch" href="/assets/js/53.7a1a6a29.js"><link rel="prefetch" href="/assets/js/54.2724852a.js"><link rel="prefetch" href="/assets/js/55.22d0f102.js"><link rel="prefetch" href="/assets/js/56.4f5ccb00.js"><link rel="prefetch" href="/assets/js/57.51b74062.js"><link rel="prefetch" href="/assets/js/58.bb02da00.js"><link rel="prefetch" href="/assets/js/59.24d5973e.js"><link rel="prefetch" href="/assets/js/6.77b934eb.js"><link rel="prefetch" href="/assets/js/60.b6f5b511.js"><link rel="prefetch" href="/assets/js/61.263a6a82.js"><link rel="prefetch" href="/assets/js/62.64e86af7.js"><link rel="prefetch" href="/assets/js/63.edaec9f8.js"><link rel="prefetch" href="/assets/js/64.f5603841.js"><link rel="prefetch" href="/assets/js/65.ea74d0f8.js"><link rel="prefetch" href="/assets/js/66.c9d3b31e.js"><link rel="prefetch" href="/assets/js/67.f8323216.js"><link rel="prefetch" href="/assets/js/68.628f2adb.js"><link rel="prefetch" href="/assets/js/69.227f40c7.js"><link rel="prefetch" href="/assets/js/7.b4d7955c.js"><link rel="prefetch" href="/assets/js/70.f031d94a.js"><link rel="prefetch" href="/assets/js/71.ded13eff.js"><link rel="prefetch" href="/assets/js/72.04ba11ee.js"><link rel="prefetch" href="/assets/js/73.00abe605.js"><link rel="prefetch" href="/assets/js/74.f2b01df9.js"><link rel="prefetch" href="/assets/js/75.5e3035a9.js"><link rel="prefetch" href="/assets/js/76.2fbbd523.js"><link rel="prefetch" href="/assets/js/77.2d330847.js"><link rel="prefetch" href="/assets/js/78.e2069614.js"><link rel="prefetch" href="/assets/js/79.65d206a2.js"><link rel="prefetch" href="/assets/js/80.775ecab5.js"><link rel="prefetch" href="/assets/js/81.a8f92c39.js"><link rel="prefetch" href="/assets/js/82.7f4cf40f.js"><link rel="prefetch" href="/assets/js/83.3ee310e8.js"><link rel="prefetch" href="/assets/js/84.92c2cd69.js"><link rel="prefetch" href="/assets/js/85.0de08a5f.js"><link rel="prefetch" href="/assets/js/86.89ffa94f.js"><link rel="prefetch" href="/assets/js/87.25c61aa4.js"><link rel="prefetch" href="/assets/js/88.478207d5.js"><link rel="prefetch" href="/assets/js/89.97283ade.js"><link rel="prefetch" href="/assets/js/90.6d82b087.js"><link rel="prefetch" href="/assets/js/91.b37732a6.js"><link rel="prefetch" href="/assets/js/92.f4529475.js"><link rel="prefetch" href="/assets/js/93.c7fe2ccf.js"><link rel="prefetch" href="/assets/js/94.dcdb13ff.js"><link rel="prefetch" href="/assets/js/95.15de86a5.js"><link rel="prefetch" href="/assets/js/96.f0298999.js"><link rel="prefetch" href="/assets/js/97.76d27b68.js"><link rel="prefetch" href="/assets/js/98.d8eb9de5.js"><link rel="prefetch" href="/assets/js/99.d832312f.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.68b347c4.js">
    <link rel="stylesheet" href="/assets/css/0.styles.96eb8417.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">前端源码解读</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Vue2相关" class="dropdown-title"><span class="title">Vue2相关</span> <span class="arrow down"></span></button> <button type="button" aria-label="Vue2相关" class="mobile-dropdown-title"><span class="title">Vue2相关</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vue2/" class="nav-link router-link-active">
  Vue2
</a></li><li class="dropdown-item"><!----> <a href="/vueRouter3/" class="nav-link">
  Vue Route V3
</a></li><li class="dropdown-item"><!----> <a href="/vuex3/" class="nav-link">
  VueX V3
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Vue3相关" class="dropdown-title"><span class="title">Vue3相关</span> <span class="arrow down"></span></button> <button type="button" aria-label="Vue3相关" class="mobile-dropdown-title"><span class="title">Vue3相关</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vue3/" class="nav-link">
  Vue3
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/CrayonPig/originCodeCommit" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Vue2相关" class="dropdown-title"><span class="title">Vue2相关</span> <span class="arrow down"></span></button> <button type="button" aria-label="Vue2相关" class="mobile-dropdown-title"><span class="title">Vue2相关</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vue2/" class="nav-link router-link-active">
  Vue2
</a></li><li class="dropdown-item"><!----> <a href="/vueRouter3/" class="nav-link">
  Vue Route V3
</a></li><li class="dropdown-item"><!----> <a href="/vuex3/" class="nav-link">
  VueX V3
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Vue3相关" class="dropdown-title"><span class="title">Vue3相关</span> <span class="arrow down"></span></button> <button type="button" aria-label="Vue3相关" class="mobile-dropdown-title"><span class="title">Vue3相关</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vue3/" class="nav-link">
  Vue3
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/CrayonPig/originCodeCommit" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/vue2/" aria-current="page" class="sidebar-link">Vue2源码解析</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>准备工作</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue2/prepare/directory.html" class="sidebar-link">目录结构</a></li><li><a href="/vue2/prepare/version.html" class="sidebar-link">构建版本</a></li><li><a href="/vue2/prepare/build.html" class="sidebar-link">源码构建</a></li><li><a href="/vue2/prepare/entry.html" class="sidebar-link">源码入口</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>变化侦测</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue2/reactive/" class="sidebar-link">简介</a></li><li><a href="/vue2/reactive/object.html" class="sidebar-link">Object的变化侦测</a></li><li><a href="/vue2/reactive/array.html" class="sidebar-link">Array的变化侦测</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>虚拟DOM</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue2/vnode/" class="sidebar-link">简介</a></li><li><a href="/vue2/vnode/vnode.html" class="sidebar-link">Vue中的虚拟DOM</a></li><li><a href="/vue2/vnode/patch.html" class="sidebar-link">patch（Diff算法）</a></li><li><a href="/vue2/vnode/updateChildren.html" class="sidebar-link">更新子节点</a></li><li><a href="/vue2/vnode/optimizeUpdateChildren.html" class="sidebar-link">优化更新子节点</a></li><li><a href="/vue2/vnode/diffSummary.html" class="sidebar-link">Diff算法总结</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>模板编译</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue2/compile/" class="sidebar-link">简介</a></li><li><a href="/vue2/compile/parse.html" class="sidebar-link">模板解析阶段（整体运行流程）</a></li><li><a href="/vue2/compile/parseHtml.html" class="sidebar-link">模板解析阶段（HTML解析器）</a></li><li><a href="/vue2/compile/parseTxt.html" class="sidebar-link">模板解析阶段（文本解析器）</a></li><li><a href="/vue2/compile/optimize.html" class="sidebar-link">优化阶段</a></li><li><a href="/vue2/compile/codegen.html" class="sidebar-link">代码生成阶段</a></li><li><a href="/vue2/compile/summary.html" class="sidebar-link">总结</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>生命周期</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue2/lifecycle/" class="sidebar-link">简介</a></li><li><a href="/vue2/lifecycle/newVue.html" class="sidebar-link">初始化阶段(new Vue)</a></li><li><a href="/vue2/lifecycle/mergeOptions.html" class="sidebar-link">初始化阶段(合并属性)</a></li><li><a href="/vue2/lifecycle/initLifecycle.html" class="sidebar-link">初始化阶段(initLifecycle)</a></li><li><a href="/vue2/lifecycle/initEvents.html" class="sidebar-link">初始化阶段(initEvents)</a></li><li><a href="/vue2/lifecycle/initRender.html" class="sidebar-link">初始化阶段(initRender)</a></li><li><a href="/vue2/lifecycle/initInjections.html" class="sidebar-link">初始化阶段(initInjections)</a></li><li><a href="/vue2/lifecycle/initState.html" class="sidebar-link">初始化阶段(initState)</a></li><li><a href="/vue2/lifecycle/initProvide.html" class="sidebar-link">初始化阶段(initProvide)</a></li><li><a href="/vue2/lifecycle/templateCompile.html" class="sidebar-link">模板编译阶段</a></li><li><a href="/vue2/lifecycle/mount.html" class="sidebar-link">挂载阶段</a></li><li><a href="/vue2/lifecycle/destroy.html" class="sidebar-link">销毁阶段</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>实例方法</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue2/instanceMethods/data.html" class="sidebar-link">数据相关的方法</a></li><li><a href="/vue2/instanceMethods/event.html" class="sidebar-link">事件相关的方法</a></li><li><a href="/vue2/instanceMethods/lifecycle.html" class="sidebar-link">生命周期相关的方法</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>全局API</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue2/globalAPI/" class="sidebar-link">前言</a></li><li><a href="/vue2/globalAPI/extend.html" class="sidebar-link">Vue.extend</a></li><li><a href="/vue2/globalAPI/nextTick.html" class="sidebar-link">Vue.nextTick</a></li><li><a href="/vue2/globalAPI/set.html" class="sidebar-link">Vue.set</a></li><li><a href="/vue2/globalAPI/delete.html" class="sidebar-link">Vue.delete</a></li><li><a href="/vue2/globalAPI/directive.html" class="sidebar-link">Vue.directive</a></li><li><a href="/vue2/globalAPI/filter.html" class="sidebar-link">Vue.filter</a></li><li><a href="/vue2/globalAPI/component.html" class="sidebar-link">Vue.component</a></li><li><a href="/vue2/globalAPI/use.html" class="sidebar-link">Vue.use</a></li><li><a href="/vue2/globalAPI/mixin.html" class="sidebar-link">Vue.mixin</a></li><li><a href="/vue2/globalAPI/compile.html" class="sidebar-link">Vue.compile</a></li><li><a href="/vue2/globalAPI/observable.html" class="sidebar-link">Vue.observable</a></li><li><a href="/vue2/globalAPI/version.html" class="sidebar-link">Vue.version</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>过滤器</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue2/filter/" class="sidebar-link">用法回顾</a></li><li><a href="/vue2/filter/parse.html" class="sidebar-link">过滤器解析器</a></li><li><a href="/vue2/filter/principle.html" class="sidebar-link">工作原理</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>指令</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue2/directives/" class="sidebar-link">前言</a></li><li><a href="/vue2/directives/custom.html" class="sidebar-link">自定义指令</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>内置组件</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue2/builtInComponents/keepalive.html" aria-current="page" class="active sidebar-link">keep-alive</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vue2/builtInComponents/keepalive.html#用法回顾" class="sidebar-link">用法回顾</a></li><li class="sidebar-sub-header"><a href="/vue2/builtInComponents/keepalive.html#原理分析" class="sidebar-link">原理分析</a></li><li class="sidebar-sub-header"><a href="/vue2/builtInComponents/keepalive.html#总结" class="sidebar-link">总结</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="keep-alive"><a href="#keep-alive" class="header-anchor">#</a> keep-alive</h1> <p><code>&lt;keep-alive&gt;</code> 包裹动态组件时，会缓存不活动的组件实例，而不是销毁它们。和 <code>&lt;transition&gt;</code> 相似，<code>&lt;keep-alive&gt;</code> 是一个抽象组件：它自身不会渲染一个 DOM 元素，也不会出现在组件的父组件链中。</p> <p>当组件在 <code>&lt;keep-alive&gt;</code> 内被切换，它的 <code>activated</code> 和 <code>deactivated</code> 这两个生命周期钩子函数将会被对应执行。</p> <blockquote><p>在 2.2.0 及其更高版本中，<code>activated</code> 和 <code>deactivated</code> 将会在 <code>&lt;keep-alive&gt;</code> 树内的所有嵌套组件中触发。</p></blockquote> <p>主要用于保留组件状态或避免重新渲染。</p> <h2 id="用法回顾"><a href="#用法回顾" class="header-anchor">#</a> 用法回顾</h2> <p>介绍原理之前，我们先根据官方文档来回顾一下<code>&lt;keep-alive&gt;</code>组件的具体用法，如下：</p> <p><code>&lt;keep-alive&gt;</code>组件可接收三个属性：</p> <ul><li><code>include</code> - 字符串或正则表达式。只有名称匹配的组件会被缓存。</li> <li><code>exclude</code> - 字符串或正则表达式。任何名称匹配的组件都不会被缓存。</li> <li><code>max</code> - 数字。最多可以缓存多少组件实例。</li></ul> <p><code>include</code> 和 <code>exclude</code> 属性允许组件有条件地缓存。二者都可以用逗号分隔字符串、正则表达式或一个数组来表示：</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token comment">&lt;!-- 逗号分隔字符串 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>keep-alive</span> <span class="token attr-name">include</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>a,b<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>component</span> <span class="token attr-name">:is</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>view<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>component</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>keep-alive</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- 正则表达式 (使用 `v-bind`) --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>keep-alive</span> <span class="token attr-name">:include</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/a|b/<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>component</span> <span class="token attr-name">:is</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>view<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>component</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>keep-alive</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- 数组 (使用 `v-bind`) --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>keep-alive</span> <span class="token attr-name">:include</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>['a', 'b']<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>component</span> <span class="token attr-name">:is</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>view<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>component</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>keep-alive</span><span class="token punctuation">&gt;</span></span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1701941076131-91164">成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="&lt;!-- 逗号分隔字符串 --&gt;
&lt;keep-alive include=&quot;a,b&quot;&gt;
  &lt;component :is=&quot;view&quot;&gt;&lt;/component&gt;
&lt;/keep-alive&gt;

&lt;!-- 正则表达式 (使用 `v-bind`) --&gt;
&lt;keep-alive :include=&quot;/a|b/&quot;&gt;
  &lt;component :is=&quot;view&quot;&gt;&lt;/component&gt;
&lt;/keep-alive&gt;

&lt;!-- 数组 (使用 `v-bind`) --&gt;
&lt;keep-alive :include=&quot;['a', 'b']&quot;&gt;
  &lt;component :is=&quot;view&quot;&gt;&lt;/component&gt;
&lt;/keep-alive&gt;
" data-mdic-attach-content="" data-mdic-notify-id="j-notify-1701941076131-91164" data-mdic-notify-delay="2000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t='',e='')=&gt;new Promise((c,o)=&gt;{const n=document.createElement('textarea'),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display='block',setTimeout(()=&gt;{n.style.display='none'},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制代码</button></div></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>匹配时首先检查组件自身的 <code>name</code> 选项，如果 <code>name</code> 选项不可用，则匹配它的局部注册名称 (父组件 <code>components</code> 选项的键值)，也就是组件的标签值。匿名组件不能被匹配。</p> <p><code>max</code>表示最多可以缓存多少组件实例。一旦这个数字达到了，在新实例被创建之前，<strong>已缓存组件中最久没有被访问的实例</strong>会被销毁掉。</p> <p>请读者注意此处加粗的地方，暂时有个印象，后面我们会详细说明。</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>keep-alive</span> <span class="token attr-name">:max</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>10<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>component</span> <span class="token attr-name">:is</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>view<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>component</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>keep-alive</span><span class="token punctuation">&gt;</span></span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1701941076136-71100">成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="&lt;keep-alive :max=&quot;10&quot;&gt;
  &lt;component :is=&quot;view&quot;&gt;&lt;/component&gt;
&lt;/keep-alive&gt;
" data-mdic-attach-content="" data-mdic-notify-id="j-notify-1701941076136-71100" data-mdic-notify-delay="2000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t='',e='')=&gt;new Promise((c,o)=&gt;{const n=document.createElement('textarea'),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display='block',setTimeout(()=&gt;{n.style.display='none'},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制代码</button></div></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>OK，以上就是<code>&lt;keep-alive&gt;</code>组件的用法，下面我们将着重介绍其内部实现原理。</p> <h2 id="原理分析"><a href="#原理分析" class="header-anchor">#</a> 原理分析</h2> <p><code>&lt;keep-alive&gt;</code>组件的定义位于源码的 <code>src/core/components/keep-alive.js</code> 文件中，如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'keep-alive'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">abstract</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>

  <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// include 表示只有匹配到的组件会被缓存</span>
    <span class="token literal-property property">include</span><span class="token operator">:</span> patternTypes<span class="token punctuation">,</span>
    <span class="token comment">// exclude 表示任何匹配到的组件都不会被缓存</span>
    <span class="token literal-property property">exclude</span><span class="token operator">:</span> patternTypes<span class="token punctuation">,</span>
    <span class="token comment">// 缓存组件的数量</span>
    <span class="token literal-property property">max</span><span class="token operator">:</span> <span class="token punctuation">[</span>String<span class="token punctuation">,</span> Number<span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token function">created</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 初始化缓存对象</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>cache <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token comment">// 初始化节点key集合，就是this.cache的键值</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>keys <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token function">destroyed</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 遍历缓存对象，挨个销毁</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cache<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">pruneCacheEntry</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>cache<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>keys<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token function">mounted</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 监听include和exclude，如果发生变化则调用pruneCache</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$watch</span><span class="token punctuation">(</span><span class="token string">'include'</span><span class="token punctuation">,</span> <span class="token parameter">val</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">pruneCache</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token parameter">name</span> <span class="token operator">=&gt;</span> <span class="token function">matches</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$watch</span><span class="token punctuation">(</span><span class="token string">'exclude'</span><span class="token punctuation">,</span> <span class="token parameter">val</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">pruneCache</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token parameter">name</span> <span class="token operator">=&gt;</span> <span class="token operator">!</span><span class="token function">matches</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token function">render</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取插槽中第一个节点</span>
    <span class="token keyword">const</span> slot <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$slots<span class="token punctuation">.</span>default
    <span class="token keyword">const</span> <span class="token literal-property property">vnode</span><span class="token operator">:</span> VNode <span class="token operator">=</span> <span class="token function">getFirstComponentChild</span><span class="token punctuation">(</span>slot<span class="token punctuation">)</span>

    <span class="token keyword">const</span> <span class="token literal-property property">componentOptions</span><span class="token operator">:</span> <span class="token operator">?</span>VNodeComponentOptions <span class="token operator">=</span> vnode <span class="token operator">&amp;&amp;</span> vnode<span class="token punctuation">.</span>componentOptions
    <span class="token keyword">if</span> <span class="token punctuation">(</span>componentOptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 获取节点的名称，优先获取节点的name字段，如果name不存在则获取节点的tag</span>
      <span class="token keyword">const</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token operator">?</span>string <span class="token operator">=</span> <span class="token function">getComponentName</span><span class="token punctuation">(</span>componentOptions<span class="token punctuation">)</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> include<span class="token punctuation">,</span> exclude <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>
        <span class="token comment">// 如果name不在include中</span>
        <span class="token punctuation">(</span>include <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span>name <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">matches</span><span class="token punctuation">(</span>include<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span>
        <span class="token comment">// 如果name存在于exclude中</span>
        <span class="token punctuation">(</span>exclude <span class="token operator">&amp;&amp;</span> name <span class="token operator">&amp;&amp;</span> <span class="token function">matches</span><span class="token punctuation">(</span>exclude<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 不缓存，直接返回</span>
        <span class="token keyword">return</span> vnode
      <span class="token punctuation">}</span>

      <span class="token keyword">const</span> <span class="token punctuation">{</span> cache<span class="token punctuation">,</span> keys <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span>
      <span class="token comment">// 获取当前节点的key</span>
      <span class="token keyword">const</span> <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token operator">?</span>string <span class="token operator">=</span> vnode<span class="token punctuation">.</span>key <span class="token operator">==</span> <span class="token keyword">null</span>
        <span class="token comment">// same constructor may get registered as different local components</span>
        <span class="token comment">// so cid alone is not enough (#3269)</span>
        <span class="token operator">?</span> componentOptions<span class="token punctuation">.</span>Ctor<span class="token punctuation">.</span>cid <span class="token operator">+</span> <span class="token punctuation">(</span>componentOptions<span class="token punctuation">.</span>tag <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">::</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>componentOptions<span class="token punctuation">.</span>tag<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">)</span>
        <span class="token operator">:</span> vnode<span class="token punctuation">.</span>key
      <span class="token comment">// 如果缓存中存在组件</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 从缓存中读取各种选项信息赋值给当前的节点</span>
        vnode<span class="token punctuation">.</span>componentInstance <span class="token operator">=</span> cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>componentInstance
        <span class="token comment">// 通过删除和重新添加key，将key放在缓存最后</span>
        <span class="token comment">// 防止超出最大缓存条数被删除</span>
        <span class="token function">remove</span><span class="token punctuation">(</span>keys<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
        keys<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 当前vnode存入缓存中</span>
        cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> vnode
        keys<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
        <span class="token comment">// 如果超出最大缓存条数，则删除存储的第一条，也就是最早存储的一条</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>max <span class="token operator">&amp;&amp;</span> keys<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>max<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">pruneCacheEntry</span><span class="token punctuation">(</span>cache<span class="token punctuation">,</span> keys<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> keys<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_vnode<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      vnode<span class="token punctuation">.</span>data<span class="token punctuation">.</span>keepAlive <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> vnode <span class="token operator">||</span> <span class="token punctuation">(</span>slot <span class="token operator">&amp;&amp;</span> slot<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1701941076136-51195">成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="export default {
  name: 'keep-alive',
  abstract: true,

  props: {
    // include 表示只有匹配到的组件会被缓存
    include: patternTypes,
    // exclude 表示任何匹配到的组件都不会被缓存
    exclude: patternTypes,
    // 缓存组件的数量
    max: [String, Number]
  },

  created () {
    // 初始化缓存对象
    this.cache = Object.create(null)
    // 初始化节点key集合，就是this.cache的键值
    this.keys = []
  },

  destroyed () {
    // 遍历缓存对象，挨个销毁
    for (const key in this.cache) {
      pruneCacheEntry(this.cache, key, this.keys)
    }
  },

  mounted () {
    // 监听include和exclude，如果发生变化则调用pruneCache
    this.$watch('include', val =&gt; {
      pruneCache(this, name =&gt; matches(val, name))
    })
    this.$watch('exclude', val =&gt; {
      pruneCache(this, name =&gt; !matches(val, name))
    })
  },

  render () {
    // 获取插槽中第一个节点
    const slot = this.$slots.default
    const vnode: VNode = getFirstComponentChild(slot)

    const componentOptions: ?VNodeComponentOptions = vnode &amp;&amp; vnode.componentOptions
    if (componentOptions) {
      // 获取节点的名称，优先获取节点的name字段，如果name不存在则获取节点的tag
      const name: ?string = getComponentName(componentOptions)
      const { include, exclude } = this
      if (
        // 如果name不在include中
        (include &amp;&amp; (!name || !matches(include, name))) ||
        // 如果name存在于exclude中
        (exclude &amp;&amp; name &amp;&amp; matches(exclude, name))
      ) {
        // 不缓存，直接返回
        return vnode
      }

      const { cache, keys } = this
      // 获取当前节点的key
      const key: ?string = vnode.key == null
        // same constructor may get registered as different local components
        // so cid alone is not enough (#3269)
        ? componentOptions.Ctor.cid + (componentOptions.tag ? `::${componentOptions.tag}` : '')
        : vnode.key
      // 如果缓存中存在组件
      if (cache[key]) {
        // 从缓存中读取各种选项信息赋值给当前的节点
        vnode.componentInstance = cache[key].componentInstance
        // 通过删除和重新添加key，将key放在缓存最后
        // 防止超出最大缓存条数被删除
        remove(keys, key)
        keys.push(key)
      } else {
        // 当前vnode存入缓存中
        cache[key] = vnode
        keys.push(key)
        // 如果超出最大缓存条数，则删除存储的第一条，也就是最早存储的一条
        if (this.max &amp;&amp; keys.length &gt; parseInt(this.max)) {
          pruneCacheEntry(cache, keys[0], keys, this._vnode)
        }
      }

      vnode.data.keepAlive = true
    }
    return vnode || (slot &amp;&amp; slot[0])
  }
}
" data-mdic-attach-content="" data-mdic-notify-id="j-notify-1701941076136-51195" data-mdic-notify-delay="2000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t='',e='')=&gt;new Promise((c,o)=&gt;{const n=document.createElement('textarea'),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display='block',setTimeout(()=&gt;{n.style.display='none'},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制代码</button></div></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br></div></div><p>我们发现<code>&lt;keep-alive&gt;</code>是一个函数式组件，没有常规的<code>&lt;template&gt;&lt;/template&gt;</code>标签，执行 <code>&lt;keep-alive&gt;</code> 组件渲染的时候，就会执行到这个 <code>render</code> 函数。</p> <p>具体逻辑注释里描述的很详细了，这里重点说几个问题</p> <ol><li>为什么要删除第一个缓存组件并且为什么命中缓存了还要调整组件key的顺序？</li></ol> <p>这其实应用了一个缓存淘汰策略LRU：</p> <blockquote><p>LRU（<strong>Least recently used</strong>，最近最少使用）算法根据数据的历史访问记录来进行淘汰数据，其核心思想是“如果数据最近被访问过，那么将来被访问的几率也更高”。</p></blockquote> <p>它的算法是这样子的：</p> <p><img src="/assets/img/LRU.bfadecb3.png" alt="LRU"></p> <ol><li>将新数据从尾部插入到<code>this.keys</code>中；</li> <li>每当缓存命中（即缓存数据被访问），则将数据移到<code>this.keys</code>的尾部；</li> <li>当<code>this.keys</code>满的时候，将头部的数据丢弃；</li></ol> <p>LRU的核心思想是如果数据最近被访问过，那么将来被访问的几率也更高，所以我们将命中缓存的组件<code>key</code>重新插入到<code>this.keys</code>的尾部，这样一来，<code>this.keys</code>中越往头部的数据即将来被访问几率越低，所以当缓存数量达到最大值时，我们就删除将来被访问几率最低的数据，即<code>this.keys</code>中第一个缓存的组件。这也就之前加粗强调的<strong>已缓存组件中最久没有被访问的实例</strong>会被销毁掉的原因所在。</p> <ol start="2"><li>为什么缓存<code>vnode.componentInstance</code>后就可以保存所有的状态？</li></ol> <p><code>vnode.componentOptions</code>是在Vue中用于表示组件选项的一个属性。当使用Vue渲染组件时，虚拟DOM节点（VNode）的<code>componentOptions</code>属性存储了该组件的各种选项信息，包括组件的构造函数、组件的props数据、组件的监听器、组件的插槽信息等。</p> <p>所以重新渲染该节点时，只需要将<code>componentOptions</code>赋值给新渲染的组件即可。</p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>本小节介绍了<code>&lt;keep-alive&gt;</code>组件的用法和实现原理。</p> <p>首先，根据官方文档回顾了<code>&lt;keep-alive&gt;</code>组件的具体用法。</p> <p>然后，从源码角度深入分析了<code>&lt;keep-alive&gt;</code>组件的内部原理，并且知道了该组件使用了LRU的缓存策略。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/vue2/directives/custom.html" class="prev">
        自定义指令
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.ea1ce679.js" defer></script><script src="/assets/js/2.88c18509.js" defer></script><script src="/assets/js/1.d4c099ff.js" defer></script><script src="/assets/js/28.6d1471fa.js" defer></script>
  </body>
</html>
