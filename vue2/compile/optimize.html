<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>优化阶段 | 前端源码解读</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="前端源码解读文档;使用过程中如碰到问题，请到Github进行提问。 https://github.com/CrayonPig/originCodeCommit">
    
    <link rel="preload" href="/assets/css/0.styles.96eb8417.css" as="style"><link rel="preload" href="/assets/js/app.2612fe0a.js" as="script"><link rel="preload" href="/assets/js/2.0c6f551e.js" as="script"><link rel="preload" href="/assets/js/1.515c3615.js" as="script"><link rel="preload" href="/assets/js/43.7fb12353.js" as="script"><link rel="prefetch" href="/assets/js/10.23488153.js"><link rel="prefetch" href="/assets/js/11.4424d6e6.js"><link rel="prefetch" href="/assets/js/12.0cc9fad4.js"><link rel="prefetch" href="/assets/js/13.cc5ac1e9.js"><link rel="prefetch" href="/assets/js/14.e61465c3.js"><link rel="prefetch" href="/assets/js/15.c1f36a5e.js"><link rel="prefetch" href="/assets/js/16.988e9754.js"><link rel="prefetch" href="/assets/js/17.89d8d1e4.js"><link rel="prefetch" href="/assets/js/18.6ce7a1b9.js"><link rel="prefetch" href="/assets/js/19.b57b8c1e.js"><link rel="prefetch" href="/assets/js/20.9f3d423f.js"><link rel="prefetch" href="/assets/js/21.ebc719bf.js"><link rel="prefetch" href="/assets/js/22.53525281.js"><link rel="prefetch" href="/assets/js/23.8670eb3a.js"><link rel="prefetch" href="/assets/js/24.4167e1b3.js"><link rel="prefetch" href="/assets/js/25.6e315269.js"><link rel="prefetch" href="/assets/js/26.976d8407.js"><link rel="prefetch" href="/assets/js/27.08df9a2c.js"><link rel="prefetch" href="/assets/js/28.feea2016.js"><link rel="prefetch" href="/assets/js/29.b587f44d.js"><link rel="prefetch" href="/assets/js/3.08664a71.js"><link rel="prefetch" href="/assets/js/30.99fe2aa5.js"><link rel="prefetch" href="/assets/js/31.c4448bc4.js"><link rel="prefetch" href="/assets/js/32.af6301f6.js"><link rel="prefetch" href="/assets/js/33.57173888.js"><link rel="prefetch" href="/assets/js/34.6ceb4957.js"><link rel="prefetch" href="/assets/js/35.36231491.js"><link rel="prefetch" href="/assets/js/36.b97ef84a.js"><link rel="prefetch" href="/assets/js/37.8c301c11.js"><link rel="prefetch" href="/assets/js/38.acceee70.js"><link rel="prefetch" href="/assets/js/39.7d2ddff1.js"><link rel="prefetch" href="/assets/js/4.857c463a.js"><link rel="prefetch" href="/assets/js/40.9eb3b176.js"><link rel="prefetch" href="/assets/js/41.241521d5.js"><link rel="prefetch" href="/assets/js/42.ae475d69.js"><link rel="prefetch" href="/assets/js/44.32432d39.js"><link rel="prefetch" href="/assets/js/45.7a93d327.js"><link rel="prefetch" href="/assets/js/46.fcab1504.js"><link rel="prefetch" href="/assets/js/47.73f269eb.js"><link rel="prefetch" href="/assets/js/48.a072f377.js"><link rel="prefetch" href="/assets/js/49.d0e2d647.js"><link rel="prefetch" href="/assets/js/5.62c00dba.js"><link rel="prefetch" href="/assets/js/50.fdce575f.js"><link rel="prefetch" href="/assets/js/51.d6718cd8.js"><link rel="prefetch" href="/assets/js/52.5821ac9d.js"><link rel="prefetch" href="/assets/js/53.261d0984.js"><link rel="prefetch" href="/assets/js/54.2e159ea3.js"><link rel="prefetch" href="/assets/js/55.48b43815.js"><link rel="prefetch" href="/assets/js/56.2fc3b657.js"><link rel="prefetch" href="/assets/js/57.0c7ea200.js"><link rel="prefetch" href="/assets/js/58.a8fc6c7b.js"><link rel="prefetch" href="/assets/js/59.32a145cd.js"><link rel="prefetch" href="/assets/js/6.f84cc6e1.js"><link rel="prefetch" href="/assets/js/60.2aa99ac6.js"><link rel="prefetch" href="/assets/js/61.6163a3bf.js"><link rel="prefetch" href="/assets/js/62.9d44d641.js"><link rel="prefetch" href="/assets/js/63.5be3095f.js"><link rel="prefetch" href="/assets/js/64.caf6b8c5.js"><link rel="prefetch" href="/assets/js/65.dcb120fe.js"><link rel="prefetch" href="/assets/js/66.2853b5dd.js"><link rel="prefetch" href="/assets/js/67.2e2f50e5.js"><link rel="prefetch" href="/assets/js/68.8982b405.js"><link rel="prefetch" href="/assets/js/69.a249efe7.js"><link rel="prefetch" href="/assets/js/7.6f6bf1e7.js"><link rel="prefetch" href="/assets/js/70.11f3ed00.js"><link rel="prefetch" href="/assets/js/71.5a54cbd8.js"><link rel="prefetch" href="/assets/js/72.b2b26632.js"><link rel="prefetch" href="/assets/js/73.9c3713b5.js"><link rel="prefetch" href="/assets/js/74.e3395331.js"><link rel="prefetch" href="/assets/js/75.d92e3497.js"><link rel="prefetch" href="/assets/js/76.6bf82f69.js"><link rel="prefetch" href="/assets/js/77.524d983a.js"><link rel="prefetch" href="/assets/js/78.676f05b4.js"><link rel="prefetch" href="/assets/js/79.dcce8da2.js"><link rel="prefetch" href="/assets/js/80.db4006fe.js"><link rel="prefetch" href="/assets/js/81.d89763f7.js"><link rel="prefetch" href="/assets/js/82.f18bc4ed.js"><link rel="prefetch" href="/assets/js/83.ef12d2de.js"><link rel="prefetch" href="/assets/js/84.cd365949.js"><link rel="prefetch" href="/assets/js/85.08a42666.js"><link rel="prefetch" href="/assets/js/86.b43967c2.js"><link rel="prefetch" href="/assets/js/87.63533868.js"><link rel="prefetch" href="/assets/js/88.0c1858cc.js"><link rel="prefetch" href="/assets/js/89.40d8276c.js"><link rel="prefetch" href="/assets/js/90.283fa49e.js"><link rel="prefetch" href="/assets/js/91.c0ef5182.js"><link rel="prefetch" href="/assets/js/92.08cf9afd.js"><link rel="prefetch" href="/assets/js/93.b71ce5bd.js"><link rel="prefetch" href="/assets/js/94.eabe77aa.js"><link rel="prefetch" href="/assets/js/95.3ff0c373.js"><link rel="prefetch" href="/assets/js/96.c2dff0ea.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.68b347c4.js">
    <link rel="stylesheet" href="/assets/css/0.styles.96eb8417.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">前端源码解读</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/vue2/" class="nav-link router-link-active">
  Vue2
</a></div><div class="nav-item"><a href="/vueRouter3/" class="nav-link">
  Vue Route V3
</a></div><div class="nav-item"><a href="https://github.com/CrayonPig/originCodeCommit" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/vue2/" class="nav-link router-link-active">
  Vue2
</a></div><div class="nav-item"><a href="/vueRouter3/" class="nav-link">
  Vue Route V3
</a></div><div class="nav-item"><a href="https://github.com/CrayonPig/originCodeCommit" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/vue2/" aria-current="page" class="sidebar-link">Vue2源码解析</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>准备工作</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue2/prepare/directory.html" class="sidebar-link">目录结构</a></li><li><a href="/vue2/prepare/version.html" class="sidebar-link">构建版本</a></li><li><a href="/vue2/prepare/build.html" class="sidebar-link">源码构建</a></li><li><a href="/vue2/prepare/entry.html" class="sidebar-link">源码入口</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>变化侦测</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue2/reactive/" class="sidebar-link">简介</a></li><li><a href="/vue2/reactive/object.html" class="sidebar-link">Object的变化侦测</a></li><li><a href="/vue2/reactive/array.html" class="sidebar-link">Array的变化侦测</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>虚拟DOM</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue2/vnode/" class="sidebar-link">简介</a></li><li><a href="/vue2/vnode/vnode.html" class="sidebar-link">Vue中的虚拟DOM</a></li><li><a href="/vue2/vnode/patch.html" class="sidebar-link">patch（Diff算法）</a></li><li><a href="/vue2/vnode/updateChildren.html" class="sidebar-link">更新子节点</a></li><li><a href="/vue2/vnode/optimizeUpdateChildren.html" class="sidebar-link">优化更新子节点</a></li><li><a href="/vue2/vnode/diffSummary.html" class="sidebar-link">Diff算法总结</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>模板编译</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue2/compile/" aria-current="page" class="sidebar-link">简介</a></li><li><a href="/vue2/compile/parse.html" class="sidebar-link">模板解析阶段（整体运行流程）</a></li><li><a href="/vue2/compile/parseHtml.html" class="sidebar-link">模板解析阶段（HTML解析器）</a></li><li><a href="/vue2/compile/parseTxt.html" class="sidebar-link">模板解析阶段（文本解析器）</a></li><li><a href="/vue2/compile/optimize.html" aria-current="page" class="active sidebar-link">优化阶段</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vue2/compile/optimize.html#标记静态节点" class="sidebar-link">标记静态节点</a></li><li class="sidebar-sub-header"><a href="/vue2/compile/optimize.html#标记根静态节点" class="sidebar-link">标记根静态节点</a></li><li class="sidebar-sub-header"><a href="/vue2/compile/optimize.html#总结" class="sidebar-link">总结</a></li></ul></li><li><a href="/vue2/compile/codegen.html" class="sidebar-link">代码生成阶段</a></li><li><a href="/vue2/compile/summary.html" class="sidebar-link">总结</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>生命周期</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue2/lifecycle/" class="sidebar-link">简介</a></li><li><a href="/vue2/lifecycle/newVue.html" class="sidebar-link">初始化阶段(new Vue)</a></li><li><a href="/vue2/lifecycle/mergeOptions.html" class="sidebar-link">初始化阶段(合并属性)</a></li><li><a href="/vue2/lifecycle/initLifecycle.html" class="sidebar-link">初始化阶段(initLifecycle)</a></li><li><a href="/vue2/lifecycle/initEvents.html" class="sidebar-link">初始化阶段(initEvents)</a></li><li><a href="/vue2/lifecycle/initRender.html" class="sidebar-link">初始化阶段(initRender)</a></li><li><a href="/vue2/lifecycle/initInjections.html" class="sidebar-link">初始化阶段(initInjections)</a></li><li><a href="/vue2/lifecycle/initState.html" class="sidebar-link">初始化阶段(initState)</a></li><li><a href="/vue2/lifecycle/initProvide.html" class="sidebar-link">初始化阶段(initProvide)</a></li><li><a href="/vue2/lifecycle/templateCompile.html" class="sidebar-link">模板编译阶段</a></li><li><a href="/vue2/lifecycle/mount.html" class="sidebar-link">挂载阶段</a></li><li><a href="/vue2/lifecycle/destroy.html" class="sidebar-link">销毁阶段</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>实例方法</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue2/instanceMethods/data.html" class="sidebar-link">数据相关的方法</a></li><li><a href="/vue2/instanceMethods/event.html" class="sidebar-link">事件相关的方法</a></li><li><a href="/vue2/instanceMethods/lifecycle.html" class="sidebar-link">生命周期相关的方法</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>全局API</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue2/globalAPI/" class="sidebar-link">前言</a></li><li><a href="/vue2/globalAPI/extend.html" class="sidebar-link">Vue.extend</a></li><li><a href="/vue2/globalAPI/nextTick.html" class="sidebar-link">Vue.nextTick</a></li><li><a href="/vue2/globalAPI/set.html" class="sidebar-link">Vue.set</a></li><li><a href="/vue2/globalAPI/delete.html" class="sidebar-link">Vue.delete</a></li><li><a href="/vue2/globalAPI/directive.html" class="sidebar-link">Vue.directive</a></li><li><a href="/vue2/globalAPI/filter.html" class="sidebar-link">Vue.filter</a></li><li><a href="/vue2/globalAPI/component.html" class="sidebar-link">Vue.component</a></li><li><a href="/vue2/globalAPI/use.html" class="sidebar-link">Vue.use</a></li><li><a href="/vue2/globalAPI/mixin.html" class="sidebar-link">Vue.mixin</a></li><li><a href="/vue2/globalAPI/compile.html" class="sidebar-link">Vue.compile</a></li><li><a href="/vue2/globalAPI/observable.html" class="sidebar-link">Vue.observable</a></li><li><a href="/vue2/globalAPI/version.html" class="sidebar-link">Vue.version</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>过滤器</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue2/filter/" class="sidebar-link">用法回顾</a></li><li><a href="/vue2/filter/parse.html" class="sidebar-link">过滤器解析器</a></li><li><a href="/vue2/filter/principle.html" class="sidebar-link">工作原理</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>指令</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue2/directives/" class="sidebar-link">前言</a></li><li><a href="/vue2/directives/custom.html" class="sidebar-link">自定义指令</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>内置组件</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue2/builtInComponents/keepalive.html" class="sidebar-link">keep-alive</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="优化阶段"><a href="#优化阶段" class="header-anchor">#</a> 优化阶段</h1> <p>经过前几节，我们知道了解析器是如何将HTML模板解析成<code>AST</code>。本节我们将介绍优化器的是如何在遍历<code>AST</code>，找出其中的静态节点，并打上标记的。</p> <p>在这个过程中共分为两步</p> <ol><li>在<code>AST</code>中找出所有的<code>静态节点</code>并打上标记</li> <li>在<code>AST</code>中找出所有的<code>静态根节点</code>并打上标记</li></ol> <p><code>静态节点</code>我们已经知道是渲染到界面上后，就不会随着状态发生变化的节点。那<code>静态根节点</code>是什么呢？我们举个例子</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>我是文本信息<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>我是文本信息<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>我是文本信息<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>我是文本信息<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>我是文本信息<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1693825477825-58725">成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="&lt;ul&gt;
    &lt;li&gt;我是文本信息&lt;/li&gt;
    &lt;li&gt;我是文本信息&lt;/li&gt;
    &lt;li&gt;我是文本信息&lt;/li&gt;
    &lt;li&gt;我是文本信息&lt;/li&gt;
    &lt;li&gt;我是文本信息&lt;/li&gt;
&lt;/ul&gt;
" data-mdic-attach-content="" data-mdic-notify-id="j-notify-1693825477825-58725" data-mdic-notify-delay="2000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t='',e='')=&gt;new Promise((c,o)=&gt;{const n=document.createElement('textarea'),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display='block',setTimeout(()=&gt;{n.style.display='none'},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制代码</button></div></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>在上述例子中，所有的<code>li</code>元素中都是纯文本，一旦渲染到界面上，就不会随着状态发生改变，所以每个<code>li</code>标签都是一个<code>静态节点</code>。而<code>ul</code>元素作为父节点，它所有的子节点都是<code>静态节点</code>，我们就称它为<code>静态根节点</code>。</p> <p>搞明白<code>静态节点</code>和<code>静态根节点</code>之后，我们再来讨论，为这两个打上标记后，有什么好处？</p> <ul><li><p>每次重新渲染时，不需要为<code>静态节点</code>和<code>静态根节点</code>创建新节点</p> <p>在生成<code>vnode</code>的过程中，如果发现一个节点被标记为<code>静态节点</code>或<code>静态根节点</code>，除了首次渲染外，重新渲染时不会生成该节点，而是克隆已经存在的节点</p></li> <li><p>在<code>虚拟DOM</code>中<code>Diff</code>的过程中，可以忽略<code>静态节点</code>和<code>静态根节点</code></p> <p>在<code>Diff</code>过程中，如果发现两个节点都是相同的<code>静态节点</code>或<code>静态根节点</code>，就不需要对比和更新<code>DOM</code>的操作，直接跳过</p></li></ul> <p>搞明白这些后，我们来看源码。源码位于<code>src/compiler/optimizer.js</code>中，如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">optimize</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">root</span><span class="token operator">:</span> <span class="token operator">?</span>ASTElement<span class="token punctuation">,</span> <span class="token literal-property property">options</span><span class="token operator">:</span> CompilerOptions</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>root<span class="token punctuation">)</span> <span class="token keyword">return</span>

  <span class="token comment">// 生成静态键列表</span>
  isStaticKey <span class="token operator">=</span> <span class="token function">genStaticKeysCached</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>staticKeys <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">)</span>

  <span class="token comment">// 判断是否是保留标签</span>
  isPlatformReservedTag <span class="token operator">=</span> options<span class="token punctuation">.</span>isReservedTag <span class="token operator">||</span> no
  
  <span class="token comment">// first pass: mark all non-static nodes.</span>
  <span class="token comment">// 标记静态节点</span>
  <span class="token function">markStatic</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span>
  <span class="token comment">// second pass: mark static roots.</span>
  <span class="token comment">// 标记静态根节点</span>
  <span class="token function">markStaticRoots</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1693825477826-68043">成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="export function optimize (root: ?ASTElement, options: CompilerOptions) {
  if (!root) return

  // 生成静态键列表
  isStaticKey = genStaticKeysCached(options.staticKeys || '')

  // 判断是否是保留标签
  isPlatformReservedTag = options.isReservedTag || no
  
  // first pass: mark all non-static nodes.
  // 标记静态节点
  markStatic(root)
  // second pass: mark static roots.
  // 标记静态根节点
  markStaticRoots(root, false)
}
" data-mdic-attach-content="" data-mdic-notify-id="j-notify-1693825477826-68043" data-mdic-notify-delay="2000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t='',e='')=&gt;new Promise((c,o)=&gt;{const n=document.createElement('textarea'),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display='block',setTimeout(()=&gt;{n.style.display='none'},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制代码</button></div></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h2 id="标记静态节点"><a href="#标记静态节点" class="header-anchor">#</a> 标记静态节点</h2> <p>从<code>AST</code>中找出所有静态节点并标记其实不难，我们只需从根节点开始，先标记根节点是否为静态节点，然后看根节点如果是元素节点，那么就去向下递归它的子节点，子节点如果还有子节点那就继续向下递归，直到标记完所有节点。代码如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">markStatic</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">node</span><span class="token operator">:</span> ASTNode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 判断是否为静态节点</span>
  node<span class="token punctuation">.</span>static <span class="token operator">=</span> <span class="token function">isStatic</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 不将组件插槽内容标记为静态，以避免：</span>
    <span class="token comment">// 1. 组件无法更改插槽节点</span>
    <span class="token comment">// 2. 静态插槽内容在热重载时失败</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      <span class="token operator">!</span><span class="token function">isPlatformReservedTag</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
      node<span class="token punctuation">.</span>tag <span class="token operator">!==</span> <span class="token string">'slot'</span> <span class="token operator">&amp;&amp;</span>
      node<span class="token punctuation">.</span>attrsMap<span class="token punctuation">[</span><span class="token string">'inline-template'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword">null</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 遍历节点的子节点，并标记静态节点</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> node<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> child <span class="token operator">=</span> node<span class="token punctuation">.</span>children<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
      <span class="token function">markStatic</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span>
      <span class="token comment">// 子节点如果不是静态节点，父节点肯定不是静态节点</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>child<span class="token punctuation">.</span>static<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        node<span class="token punctuation">.</span>static <span class="token operator">=</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 如果节点具有条件指令，则遍历条件块，并标记静态节点</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>ifConditions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> l <span class="token operator">=</span> node<span class="token punctuation">.</span>ifConditions<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> block <span class="token operator">=</span> node<span class="token punctuation">.</span>ifConditions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>block
        <span class="token function">markStatic</span><span class="token punctuation">(</span>block<span class="token punctuation">)</span>
        <span class="token comment">// 条件块内不是静态节点，父节点肯定不是静态节点</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>block<span class="token punctuation">.</span>static<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          node<span class="token punctuation">.</span>static <span class="token operator">=</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1693825477826-47918">成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="function markStatic (node: ASTNode) {
  // 判断是否为静态节点
  node.static = isStatic(node)

  if (node.type === 1) {
    // 不将组件插槽内容标记为静态，以避免：
    // 1. 组件无法更改插槽节点
    // 2. 静态插槽内容在热重载时失败
    if (
      !isPlatformReservedTag(node.tag) &amp;&amp;
      node.tag !== 'slot' &amp;&amp;
      node.attrsMap['inline-template'] == null
    ) {
      return
    }

    // 遍历节点的子节点，并标记静态节点
    for (let i = 0, l = node.children.length; i &lt; l; i++) {
      const child = node.children[i]
      markStatic(child)
      // 子节点如果不是静态节点，父节点肯定不是静态节点
      if (!child.static) {
        node.static = false
      }
    }
    
    // 如果节点具有条件指令，则遍历条件块，并标记静态节点
    if (node.ifConditions) {
      for (let i = 1, l = node.ifConditions.length; i &lt; l; i++) {
        const block = node.ifConditions[i].block
        markStatic(block)
        // 条件块内不是静态节点，父节点肯定不是静态节点
        if (!block.static) {
          node.static = false
        }
      }
    }
  }
}
" data-mdic-attach-content="" data-mdic-notify-id="j-notify-1693825477826-47918" data-mdic-notify-delay="2000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t='',e='')=&gt;new Promise((c,o)=&gt;{const n=document.createElement('textarea'),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display='block',setTimeout(()=&gt;{n.style.display='none'},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制代码</button></div></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><p>上述代码，先调用<code>isStatic</code>函数判断当前节点是否为静态节点，并打上标记。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 判断是否为静态节点</span>
node<span class="token punctuation">.</span>static <span class="token operator">=</span> <span class="token function">isStatic</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1693825477826-4631">成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="// 判断是否为静态节点
node.static = isStatic(node)
" data-mdic-attach-content="" data-mdic-notify-id="j-notify-1693825477826-4631" data-mdic-notify-delay="2000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t='',e='')=&gt;new Promise((c,o)=&gt;{const n=document.createElement('textarea'),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display='block',setTimeout(()=&gt;{n.style.display='none'},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制代码</button></div></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><code>isStatic</code>函数源码如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">isStatic</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">node</span><span class="token operator">:</span> ASTNode</span><span class="token punctuation">)</span><span class="token operator">:</span> boolean <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 带变量的动态节点</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 不带变量的纯文本节点</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>pre <span class="token operator">||</span> <span class="token punctuation">(</span> <span class="token comment">// 使用指令v-pre</span>
    <span class="token operator">!</span>node<span class="token punctuation">.</span>hasBindings <span class="token operator">&amp;&amp;</span> <span class="token comment">// 没有动态绑定</span>
    <span class="token operator">!</span>node<span class="token punctuation">.</span>if <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>node<span class="token punctuation">.</span>for <span class="token operator">&amp;&amp;</span> <span class="token comment">// 没有 v-if 或 v-for 或 v-else</span>
    <span class="token operator">!</span><span class="token function">isBuiltInTag</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token comment">// 不是内置标签</span>
    <span class="token function">isPlatformReservedTag</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token comment">// 不是组件</span>
    <span class="token operator">!</span><span class="token function">isDirectChildOfTemplateFor</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token comment">// 判断节点是否是 template 标签的直接子节点且带有 v-for 属性</span>
    Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">every</span><span class="token punctuation">(</span>isStaticKey<span class="token punctuation">)</span> <span class="token comment">// 节点是否为预设的静态键</span>
  <span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1693825477826-50508">成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="function isStatic (node: ASTNode): boolean {
  if (node.type === 2) { // 带变量的动态节点
    return false
  }
  if (node.type === 3) { // 不带变量的纯文本节点
    return true
  }
  return !!(node.pre || ( // 使用指令v-pre
    !node.hasBindings &amp;&amp; // 没有动态绑定
    !node.if &amp;&amp; !node.for &amp;&amp; // 没有 v-if 或 v-for 或 v-else
    !isBuiltInTag(node.tag) &amp;&amp; // 不是内置标签
    isPlatformReservedTag(node.tag) &amp;&amp; // 不是组件
    !isDirectChildOfTemplateFor(node) &amp;&amp; // 判断节点是否是 template 标签的直接子节点且带有 v-for 属性
    Object.keys(node).every(isStaticKey) // 节点是否为预设的静态键
  ))
}
" data-mdic-attach-content="" data-mdic-notify-id="j-notify-1693825477826-50508" data-mdic-notify-delay="2000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t='',e='')=&gt;new Promise((c,o)=&gt;{const n=document.createElement('textarea'),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display='block',setTimeout(()=&gt;{n.style.display='none'},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制代码</button></div></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>当模板被解析器解析成<code>AST</code>时，会根据不同元素类型设置不同<code>type</code>值，<code>type</code>取值对应关系如下：</p> <table><thead><tr><th>type取值</th> <th>对应的AST节点类型</th></tr></thead> <tbody><tr><td>1</td> <td>元素节点</td></tr> <tr><td>2</td> <td>包含变量的动态文本节点</td></tr> <tr><td>3</td> <td>不包含变量的纯文本节点</td></tr></tbody></table> <p>上述代码逻辑较清晰，具体逻辑如下：</p> <ol><li><code>type === 2</code>，为包含变量的动态节点，说明不是静态节点</li> <li><code>type === 3</code>，为不包含变量的动态节点，说明是静态节点</li> <li>剩余情况就是<code>type === 1</code>，为元素节点，当是元素节点时需要考虑多种情况
<ol><li>如果使用了指令<code>v-pre</code>，说明是静态节点</li> <li>否则，需要同时满足以下条件才可以是静态节点
<ul><li>不能使用动态绑定语法，即标签上不能有<code>v-</code>、<code>@</code>、<code>:</code>开头的属性；</li> <li>不能使用<code>v-if</code>、<code>v-else</code>、<code>v-for</code>指令；</li> <li>不能是内置组件，即标签名不能是<code>slot</code>和<code>component</code>；</li> <li>标签名必须是平台保留标签，即不能是组件；</li> <li>当前节点的父节点不能是带有 <code>v-for</code> 的 <code>template</code> 标签；</li> <li>节点的所有属性的 <code>key</code> 都必须是静态节点才有的 <code>key</code>，注：静态节点的<code>key</code>是有限的，它只能是<code>type</code>,<code>tag</code>,<code>attrsList</code>,<code>attrsMap</code>,<code>plain</code>,<code>parent</code>,<code>children</code>,<code>attrs</code>之一；</li></ul></li></ol></li></ol> <p>判断当前节点是否为静态节点后，如果节点类型为<code>1</code>，说明是元素节点。</p> <p>首先判断元素节点是否为插槽，如果是插槽，不能将其标记为静态节点</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 不将组件插槽内容标记为静态，以避免：</span>
<span class="token comment">// 1. 组件无法更改插槽节点</span>
<span class="token comment">// 2. 静态插槽内容在热重载时失败</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>
  <span class="token operator">!</span><span class="token function">isPlatformReservedTag</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
  node<span class="token punctuation">.</span>tag <span class="token operator">!==</span> <span class="token string">'slot'</span> <span class="token operator">&amp;&amp;</span>
  node<span class="token punctuation">.</span>attrsMap<span class="token punctuation">[</span><span class="token string">'inline-template'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword">null</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1693825477827-63672">成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="// 不将组件插槽内容标记为静态，以避免：
// 1. 组件无法更改插槽节点
// 2. 静态插槽内容在热重载时失败
if (
  !isPlatformReservedTag(node.tag) &amp;&amp;
  node.tag !== 'slot' &amp;&amp;
  node.attrsMap['inline-template'] == null
) {
  return
}
" data-mdic-attach-content="" data-mdic-notify-id="j-notify-1693825477827-63672" data-mdic-notify-delay="2000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t='',e='')=&gt;new Promise((c,o)=&gt;{const n=document.createElement('textarea'),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display='block',setTimeout(()=&gt;{n.style.display='none'},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制代码</button></div></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>元素节点可能会有子节点，还需要遍历所有子节点，递归调用<code>markStatic</code>函数处理。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 遍历节点的子节点，并标记静态节点</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> node<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> child <span class="token operator">=</span> node<span class="token punctuation">.</span>children<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
  <span class="token function">markStatic</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span>
  <span class="token comment">// 子节点如果不是静态节点，父节点肯定不是静态节点</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>child<span class="token punctuation">.</span>static<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    node<span class="token punctuation">.</span>static <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1693825477827-9215">成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="// 遍历节点的子节点，并标记静态节点
for (let i = 0, l = node.children.length; i &lt; l; i++) {
  const child = node.children[i]
  markStatic(child)
  // 子节点如果不是静态节点，父节点肯定不是静态节点
  if (!child.static) {
    node.static = false
  }
}
" data-mdic-attach-content="" data-mdic-notify-id="j-notify-1693825477827-9215" data-mdic-notify-delay="2000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t='',e='')=&gt;new Promise((c,o)=&gt;{const n=document.createElement('textarea'),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display='block',setTimeout(()=&gt;{n.style.display='none'},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制代码</button></div></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>这里需要注意的是，如果递归完毕后，发现子节点不是静态节点，那父节点肯定不能为静态节点，需要进行处理。</p> <p>这是因为我们在判断的时候是从上往下判断的，也就是说先判断当前节点，再判断当前节点的子节点，如果当前节点在一开始被标记为了静态节点，但是通过判断子节点的时候发现有一个子节点却不是静态节点，这就有问题了，我们之前说过一旦标记为静态节点，就说明这个节点首次渲染之后不会再发生任何变化，但是它的一个子节点却又是可以变化的，就出现了自相矛盾，所以我们需要当发现它的子节点中有一个不是静态节点的时候，就得把当前节点重新设置为非静态节点</p> <p>循环<code>node.children</code>后还不算把所有子节点都遍历完，因为如果当前节点的子节点中有标签带有<code>v-if</code>、<code>v-else-if</code>、<code>v-else</code>等指令时，这些子节点在每次渲染时都只渲染一个，所以其余没有被渲染的肯定不在<code>node.children</code>中，而是存在于<code>node.ifConditions</code>，所以我们还要把<code>node.ifConditions</code>循环一遍，如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 如果节点具有条件指令，则遍历条件块，并标记静态节点</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>ifConditions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> l <span class="token operator">=</span> node<span class="token punctuation">.</span>ifConditions<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> block <span class="token operator">=</span> node<span class="token punctuation">.</span>ifConditions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>block
    <span class="token function">markStatic</span><span class="token punctuation">(</span>block<span class="token punctuation">)</span>
    <span class="token comment">// 条件块内不是静态节点，父节点肯定不是静态节点</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>block<span class="token punctuation">.</span>static<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      node<span class="token punctuation">.</span>static <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1693825477827-13148">成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="// 如果节点具有条件指令，则遍历条件块，并标记静态节点
if (node.ifConditions) {
  for (let i = 1, l = node.ifConditions.length; i &lt; l; i++) {
    const block = node.ifConditions[i].block
    markStatic(block)
    // 条件块内不是静态节点，父节点肯定不是静态节点
    if (!block.static) {
      node.static = false
    }
  }
}
" data-mdic-attach-content="" data-mdic-notify-id="j-notify-1693825477827-13148" data-mdic-notify-delay="2000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t='',e='')=&gt;new Promise((c,o)=&gt;{const n=document.createElement('textarea'),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display='block',setTimeout(()=&gt;{n.style.display='none'},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制代码</button></div></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>同样的，如果条件块内不是静态节点，那父节点肯定不是静态节点，需要将其改为非静态节点</p> <h2 id="标记根静态节点"><a href="#标记根静态节点" class="header-anchor">#</a> 标记根静态节点</h2> <p>找出根静态节点的过程跟找出静态节点的过程类似，都是从根节点往下一层层的递归查找。不同的是，如果一个节点被判定为静态根节点，那么将不会继续向它的子级继续寻找。因为静态节点树肯定只有一个根，就是最上面的那个静态节点。</p> <p>源码如下</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/**
 * 标记静态根节点
 * @param {ASTNode} node - 节点
 * @param {boolean} isInFor - 是否在 v-for 指令中
 */</span>
<span class="token keyword">function</span> <span class="token function">markStaticRoots</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">node</span><span class="token operator">:</span> ASTNode<span class="token punctuation">,</span> <span class="token literal-property property">isInFor</span><span class="token operator">:</span> boolean</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 只能是元素节点</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果节点是静态节点或者只渲染一次的节点，设置 staticInFor 属性为 isInFor</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>static <span class="token operator">||</span> node<span class="token punctuation">.</span>once<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      node<span class="token punctuation">.</span>staticInFor <span class="token operator">=</span> isInFor
    <span class="token punctuation">}</span>

    <span class="token comment">// 要使节点符合静态根节点的要求，它必须有子节点</span>
    <span class="token comment">// 这个子节点不能是只有一个静态文本的子节点，否则优化成本将超过收益</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>static <span class="token operator">&amp;&amp;</span> node<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>
      node<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span>
      node<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token number">3</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      node<span class="token punctuation">.</span>staticRoot <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      node<span class="token punctuation">.</span>staticRoot <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 遍历节点的子节点，并递归调用 markStaticRoots 函数</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> node<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">markStaticRoots</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>children<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> isInFor <span class="token operator">||</span> <span class="token operator">!</span><span class="token operator">!</span>node<span class="token punctuation">.</span>for<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 如果节点具有条件指令，继续遍历条件块，并递归调用 markStaticRoots 函数</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>ifConditions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> l <span class="token operator">=</span> node<span class="token punctuation">.</span>ifConditions<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">markStaticRoots</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>ifConditions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>block<span class="token punctuation">,</span> isInFor<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1693825477827-62984">成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="/**
 * 标记静态根节点
 * @param {ASTNode} node - 节点
 * @param {boolean} isInFor - 是否在 v-for 指令中
 */
function markStaticRoots (node: ASTNode, isInFor: boolean) {
  // 只能是元素节点
  if (node.type === 1) {
    // 如果节点是静态节点或者只渲染一次的节点，设置 staticInFor 属性为 isInFor
    if (node.static || node.once) {
      node.staticInFor = isInFor
    }

    // 要使节点符合静态根节点的要求，它必须有子节点
    // 这个子节点不能是只有一个静态文本的子节点，否则优化成本将超过收益
    if (node.static &amp;&amp; node.children.length &amp;&amp; !(
      node.children.length === 1 &amp;&amp;
      node.children[0].type === 3
    )) {
      node.staticRoot = true
      return
    } else {
      node.staticRoot = false
    }

    // 遍历节点的子节点，并递归调用 markStaticRoots 函数
    if (node.children) {
      for (let i = 0, l = node.children.length; i &lt; l; i++) {
        markStaticRoots(node.children[i], isInFor || !!node.for)
      }
    }
    
    // 如果节点具有条件指令，继续遍历条件块，并递归调用 markStaticRoots 函数
    if (node.ifConditions) {
      for (let i = 1, l = node.ifConditions.length; i &lt; l; i++) {
        markStaticRoots(node.ifConditions[i].block, isInFor)
      }
    }
  }
}
" data-mdic-attach-content="" data-mdic-notify-id="j-notify-1693825477827-62984" data-mdic-notify-delay="2000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t='',e='')=&gt;new Promise((c,o)=&gt;{const n=document.createElement('textarea'),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display='block',setTimeout(()=&gt;{n.style.display='none'},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制代码</button></div></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p>首先先判断，是否是元素节点，因为只有元素节点才有子节点，可以找静态根节点，不然就只是一个静态子节点。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 如果节点是静态节点或者只渲染一次的节点，设置 staticInFor 属性为 isInFor</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>static <span class="token operator">||</span> node<span class="token punctuation">.</span>once<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  node<span class="token punctuation">.</span>staticInFor <span class="token operator">=</span> isInFor
<span class="token punctuation">}</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1693825477828-25494">成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="// 如果节点是静态节点或者只渲染一次的节点，设置 staticInFor 属性为 isInFor
if (node.static || node.once) {
  node.staticInFor = isInFor
}
" data-mdic-attach-content="" data-mdic-notify-id="j-notify-1693825477828-25494" data-mdic-notify-delay="2000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t='',e='')=&gt;new Promise((c,o)=&gt;{const n=document.createElement('textarea'),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display='block',setTimeout(()=&gt;{n.style.display='none'},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制代码</button></div></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>如果节点是静态节点或者只渲染一次的节点，将节点<code>staticInFor</code>属性进行标记，这是为了处理静态节点在 v-for 循环中的情况，以便在重新渲染时能够保持静态节点的稳定性。</p> <p>接下来开始判断当前节点是否为根节点</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 要使节点符合静态根节点的要求，它必须有子节点</span>
<span class="token comment">// 这个子节点不能是只有一个静态文本的子节点，否则优化成本将超过收益</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>static <span class="token operator">&amp;&amp;</span> node<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>
  node<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span>
  node<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token number">3</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  node<span class="token punctuation">.</span>staticRoot <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token keyword">return</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  node<span class="token punctuation">.</span>staticRoot <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1693825477828-6427">成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="// 要使节点符合静态根节点的要求，它必须有子节点
// 这个子节点不能是只有一个静态文本的子节点，否则优化成本将超过收益
if (node.static &amp;&amp; node.children.length &amp;&amp; !(
  node.children.length === 1 &amp;&amp;
  node.children[0].type === 3
)) {
  node.staticRoot = true
  return
} else {
  node.staticRoot = false
}
" data-mdic-attach-content="" data-mdic-notify-id="j-notify-1693825477828-6427" data-mdic-notify-delay="2000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t='',e='')=&gt;new Promise((c,o)=&gt;{const n=document.createElement('textarea'),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display='block',setTimeout(()=&gt;{n.style.display='none'},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制代码</button></div></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>从上述代码中，我们可以知道，一个元素节点必须要满足一下条件才成为静态根节点，不然优化成本就会大于收益</p> <ul><li>节点本身必须是静态节点</li> <li>必须拥有子节点 <code>children</code></li> <li>子节点不能只有一个纯文本节点</li></ul> <p>这种判断主要是为了避免一个元素节点只有一个文本节点，例如：</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>这是纯文本节点<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1693825477828-89200">成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="&lt;p&gt;这是纯文本节点&lt;/p&gt;
" data-mdic-attach-content="" data-mdic-notify-id="j-notify-1693825477828-89200" data-mdic-notify-delay="2000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t='',e='')=&gt;new Promise((c,o)=&gt;{const n=document.createElement('textarea'),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display='block',setTimeout(()=&gt;{n.style.display='none'},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制代码</button></div></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>上述代码中，也可以体现我们之前说的，如果一个节点被判定为静态根节点，那么将不会继续向它的子级继续寻找。因为静态节点树肯定只有一个根，就是最上面的那个静态节点。</p> <p>接下来，如果当前节点不是静态根节点，那就继续递归遍历它的子节点<code>node.children</code>和<code>node.ifConditions</code>，如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 遍历节点的子节点，并递归调用 markStaticRoots 函数</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> node<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">markStaticRoots</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>children<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> isInFor <span class="token operator">||</span> <span class="token operator">!</span><span class="token operator">!</span>node<span class="token punctuation">.</span>for<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 如果节点具有条件指令，继续遍历条件块，并递归调用 markStaticRoots 函数</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>ifConditions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> l <span class="token operator">=</span> node<span class="token punctuation">.</span>ifConditions<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">markStaticRoots</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>ifConditions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>block<span class="token punctuation">,</span> isInFor<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><div class="m-mdic-copy-wrapper"><div class="u-mdic-copy-notify" id="j-notify-1693825477828-11476">成功</div><button class="u-mdic-copy-btn j-mdic-copy-btn" data-mdic-content="// 遍历节点的子节点，并递归调用 markStaticRoots 函数
if (node.children) {
  for (let i = 0, l = node.children.length; i &lt; l; i++) {
    markStaticRoots(node.children[i], isInFor || !!node.for)
  }
}

// 如果节点具有条件指令，继续遍历条件块，并递归调用 markStaticRoots 函数
if (node.ifConditions) {
  for (let i = 1, l = node.ifConditions.length; i &lt; l; i++) {
    markStaticRoots(node.ifConditions[i].block, isInFor)
  }
}
" data-mdic-attach-content="" data-mdic-notify-id="j-notify-1693825477828-11476" data-mdic-notify-delay="2000" data-mdic-copy-fail-text="copy fail" onclick="!function(t){const e={copy:(t='',e='')=&gt;new Promise((c,o)=&gt;{const n=document.createElement('textarea'),d=e?`\n\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&amp;&amp;t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=&gt;{n.style.display='block',setTimeout(()=&gt;{n.style.display='none'},d)}).catch(()=&gt;{alert(i)})}};e.btnClick(t)}(this);">复制代码</button></div></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>这里跟之前的查找静态节点逻辑一致，就不重复说明了。</p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>本小节，我们一起研究了模板编译中的优化阶段，这个阶段主要干了两件事情</p> <ol><li>在<code>AST</code>中找出所有的<code>静态节点</code>并打上标记</li> <li>在<code>AST</code>中找出所有的<code>静态根节点</code>并打上标记</li></ol> <p>通过这两件事情，在后续<code>patch</code>过程中就可以跳过对比这些节点，提高虚拟DOM中<code>patch</code>过程的性能。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/vue2/compile/parseTxt.html" class="prev">
        模板解析阶段（文本解析器）
      </a></span> <span class="next"><a href="/vue2/compile/codegen.html">
        代码生成阶段
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.2612fe0a.js" defer></script><script src="/assets/js/2.0c6f551e.js" defer></script><script src="/assets/js/1.515c3615.js" defer></script><script src="/assets/js/43.7fb12353.js" defer></script>
  </body>
</html>
